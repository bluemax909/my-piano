<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>CLEFIO â€“ ×¢×•×œ× ×”×—××©×” + ××ª×’×¨ ×“××•</title>
  <style>
    :root{
      --card:#ffffff;
      --ink:#eaf2ff;
      --accent:#ffeb3b;
      --bg1:#040715;
      --bg2:#10182b;
      --gold:#f4b400;
      --green:#66bb6a;
      --red:#ef5350;
      --bubble-blue:#8fd3ff;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,"Segoe UI","Alef","Rubik",sans-serif;
      background:#000;
      color:var(--ink);
      overflow:hidden;
      direction:rtl;
    }

    .rotate-warning{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:#000;
      color:#fff;
      z-index:9999;
      text-align:center;
      padding:20px;
      font-size:18px;
    }
    @media (orientation:portrait){
      .rotate-warning{ display:flex; }
      .app-root{ display:none; }
    }

    .app-root{
      width:100vw;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#283593 0,#040715 55%,#000 100%);
    }

    .phone-frame{
      width:100vw;
      height:100vh;
      max-width:900px;
      max-height:520px;
      padding:8px 12px;
      border-radius:26px;
      background:linear-gradient(145deg,rgba(255,255,255,0.06),rgba(0,0,0,0.7));
      box-shadow:
        0 18px 40px rgba(0,0,0,0.85),
        0 0 40px rgba(0,150,255,0.18);
      border:1px solid rgba(255,255,255,0.16);
      position:relative;
      overflow:hidden;
      backdrop-filter:blur(20px);
      display:flex;
      flex-direction:row;
      gap:8px;
    }
    @media (max-width:720px){
      .phone-frame{
        border-radius:0;
        max-width:none;
        max-height:none;
      }
    }

    .star{
      position:absolute;
      width:3px;
      height:3px;
      border-radius:50%;
      background:radial-gradient(circle,#ffffff,#90caf9);
      opacity:.55;
      filter:blur(0.2px);
      pointer-events:none;
    }
    .star.s1{ top:6%; right:16%; }
    .star.s2{ top:14%; left:10%; }
    .star.s3{ top:34%; right:22%; }
    .star.s4{ top:58%; left:20%; }
    .star.s5{ top:78%; right:32%; }
    .star.s6{ top:30%; left:40%; }

    /* ×¦×“ ×©×××œ */
    .side-panel{
      flex:0 0 30%;
      display:flex;
      flex-direction:column;
      gap:6px;
      z-index:2;
    }
    .main-panel{
      flex:1;
      min-width:0;
      z-index:2;
      background:rgba(5,10,30,0.85);
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.18);
      padding:6px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }

    .world-title{
      text-align:right;
    }
    .world-title h1{
      margin:0;
      font-size:20px;
      color:#fffde7;
      text-shadow:0 0 12px rgba(255,255,255,0.5);
    }
    .world-sub{
      margin-top:2px;
      font-size:11px;
      color:#c5cfdd;
    }

    /* ×¤×¨×•×¤×™×œ â€“ ×§×•××¤×§×˜×™ ×™×•×ª×¨ */
    .profile-card{
      margin-top:4px;
      padding:6px;
      background:rgba(9,16,39,0.95);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.2);
      font-size:11px;
    }
    .profile-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:2px;
    }
    .profile-row:first-child{
      margin-bottom:4px;
      font-size:11px;
      font-weight:600;
    }
    .profile-pill{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.2);
      background:rgba(0,0,0,0.3);
      font-size:10px;
    }
    .profile-pill span.value{
      font-weight:700;
      color:var(--accent);
    }
    .profile-explain{
      margin-top:2px;
      font-size:9.5px;
      color:#b0bec5;
      line-height:1.3;
    }
    .version-label{
      margin-top:auto;
      font-size:10px;
      color:#90a4ae;
      text-align:right;
    }

    .screen{
      width:100%;
      height:100%;
      display:none;
    }
    .screen.active{
      display:flex;
      flex-direction:column;
    }

    /* ========== ××¡×š ×¢×•×œ××•×ª ========== */
    .world-map{
      position:relative;
      flex:1;
      border-radius:14px;
      overflow:hidden;
      background:radial-gradient(circle at top,#1a237e 0,#040715 45%,#000 100%);
      border:1px solid rgba(255,255,255,0.15);
    }

    .world-map::before{
      content:"";
      position:absolute;
      inset:20% 10%;
      border-radius:999px;
      border:2px dashed rgba(144,202,249,0.9);
      box-shadow:0 0 12px rgba(144,202,249,0.7);
      opacity:0.75;
      transform:skewX(-8deg);
    }

    .island{
      position:absolute;
      width:90px;
      height:90px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 20%,#fff9c4,#fdd835,#f9a825);
      box-shadow:0 0 0 4px rgba(255,255,255,0.7),0 10px 18px rgba(0,0,0,0.7);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      cursor:pointer;
      transition:transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      z-index:3;
    }
    .island:hover{
      transform:translateY(-4px) scale(1.03);
      box-shadow:0 0 0 5px rgba(255,255,255,0.9),0 16px 24px rgba(0,0,0,0.85);
    }
    .island.locked{
      opacity:0.35;
      cursor:default;
    }
    .island-title{
      font-size:11px;
      font-weight:700;
      color:#3e2723;
    }
    .island-sub{
      font-size:10px;
      color:#4e342e;
    }

    .island.stage1{ top:52%; left:15%; transform:translate(-50%,-50%); }
    .island.stage2{ top:35%; left:37%; transform:translate(-50%,-50%); }
    .island.stage3{ top:60%; left:60%; transform:translate(-50%,-50%); }
    .island.stage4{ top:40%; left:82%; transform:translate(-50%,-50%); }

    .bubble{
      position:absolute;
      width:34px;
      height:34px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 20%,#e1f5fe,#81d4fa,#0288d1);
      box-shadow:0 0 0 2px rgba(255,255,255,0.9),0 4px 8px rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      color:#01579b;
      font-weight:700;
      z-index:2;
      transition:transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }
    .bubble span{ transform:translateY(-1px); }
    .bubble.locked{
      opacity:0.3;
      box-shadow:0 0 0 2px rgba(255,255,255,0.4),0 2px 4px rgba(0,0,0,0.5);
    }
    .bubble.completed{
      background:radial-gradient(circle at 30% 20%,#fff9c4,#ffe082,#ffb300);
      color:#5d4037;
    }

    .bubble.s1-1{ top:30%; left:18%; }
    .bubble.s1-2{ top:22%; left:10%; }
    .bubble.s1-3{ top:38%; left:8%; }

    .bubble.s2-1{ top:20%; left:40%; }
    .bubble.s2-2{ top:32%; left:48%; }
    .bubble.s2-3{ top:44%; left:44%; }

    .bubble.s3-1{ top:45%; left:64%; }
    .bubble.s3-2{ top:30%; left:56%; }
    .bubble.s3-3{ top:68%; left:56%; }

    .bubble.s4-1{ top:22%; left:86%; }
    .bubble.s4-2{ top:34%; left:75%; }
    .bubble.s4-3{ top:54%; left:88%; }

    .world-legend{
      position:absolute;
      bottom:4px;
      left:8px;
      right:8px;
      display:flex;
      justify-content:space-between;
      font-size:10px;
      color:#c5cae9;
      z-index:4;
    }

    /* ========== ××¡×š ××ª×’×¨ ========== */
    .quiz-screen-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:4px;
      font-size:12px;
    }
    .quiz-screen-header h2{
      margin:0;
      font-size:14px;
      color:#fffde7;
    }
    .quiz-screen-header button{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.4);
      background:rgba(0,0,0,0.35);
      color:#f5f5f5;
      cursor:pointer;
      font-size:12px;
    }

    .quiz-main{
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      padding:2px 2px 4px;
      gap:3px;
    }

    .stats{
      width:100%;
      max-width:520px;
      background:rgba(9,16,39,0.9);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      padding:4px;
      font-size:10px;
    }
    .stats h3{
      margin:0 0 3px;
      font-size:11px;
      color:#e3f2fd;
      text-align:center;
    }
    .chips{
      display:flex;
      gap:4px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .chip{
      padding:2px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.25);
      font-size:10px;
    }
    .chip.green{ border-color:#4caf50; color:#c8e6c9; font-weight:600; }
    .chip.red{ border-color:#f44336; color:#ffcdd2; font-weight:600; }
    .chip.timer{ border-color:#1976d2; color:#bbdefb; font-weight:600; }

    .progress{
      width:100%;
      height:7px;
      background:#1b2235;
      border-radius:999px;
      overflow:hidden;
      box-shadow:inset 0 1px 2px rgba(0,0,0,.5);
      margin-top:3px;
    }
    .progress > span{
      display:block;
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#4caf50,#81c784);
      transition:width .3s ease;
    }

    canvas{
      border:1px solid rgba(255,255,255,0.7);
      background:#ffffff;
      margin:3px auto 3px;
      display:block;
      width:100%;
      max-width:520px;
      height:auto;
      border-radius:8px;
    }

    .muted{ color:#c5cfdd; font-size:11px; }

    .piano{
      position:relative;
      width:100%;
      max-width:540px;
      aspect-ratio:31/8; /* ××¢×˜ × ××•×š ×™×•×ª×¨ â€“ ×›×“×™ ×©×™×›× ×¡ ×‘××¡×š */
      margin:2px auto 0;
      user-select:none;
      direction:ltr;
    }
    .piano-inner{
      position:absolute;
      inset:0;
      transform-origin:center;
    }
    .piano .white-keys{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns:repeat(14,1fr);
      column-gap:0;
      align-items:end;
      justify-items:stretch;
      padding:0;
      direction:ltr;
    }
    .piano .white-keys .wkey{
      height:100%;
      background:#ffffff;
      border:1px solid #b0bec5;
      border-radius:6px;
      position:relative;
      cursor:pointer;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      font-weight:700;
      font-size:10px;
    }
    .piano .white-keys .wkey:active{ filter:brightness(0.95); }
    .piano .black-keys{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .piano .black-keys .bkey{
      position:absolute;
      height:70%;
      background:#111;
      border:1px solid #333;
      border-radius:4px;
      transform:translateX(-50%);
      z-index:10;
    }

    .middleC-arrow{
      position:absolute;
      bottom:-20px;
      left:50%;
      transform:translateX(-50%);
      height:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .middleC-arrow span{
      font-size:11px;
      color:#e0e0e0;
      background:rgba(0,0,0,0.6);
      padding:2px 8px;
      border-radius:999px;
    }

    #feedback{
      font-weight:bold;
      margin-top:2px;
      min-height:20px;
      font-size:12px;
      text-align:center;
    }
    .correct{ color:var(--green); }
    .wrong{ color:var(--red); }

    .toast{
      position:fixed;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      background:#ffffff;
      border:2px solid #ffd54f;
      border-radius:14px;
      padding:6px 10px;
      box-shadow:0 6px 16px rgba(0,0,0,.25);
      display:none;
      align-items:center;
      gap:8px;
      z-index:1000;
      font-size:12px;
      color:#333;
    }
    .toast.show{
      display:flex;
      animation:pop .4s ease;
    }
    @keyframes pop{
      0%{ transform:translate(-50%,-8px) scale(.9); opacity:0; }
      100%{ transform:translate(-50%,0) scale(1); opacity:1; }
    }

    .confetti{
      pointer-events:none;
      position:fixed;
      inset:0;
      overflow:hidden;
      z-index:999;
    }
    .confetti i{
      position:absolute;
      width:8px;
      height:14px;
      background:var(--gold);
      opacity:.9;
      transform:rotate(15deg);
      animation:fall 900ms ease-out forwards;
    }
    @keyframes fall{
      to{ transform:translateY(120vh) rotate(360deg); opacity:0; }
    }
  </style>
</head>
<body>
  <div class="rotate-warning">
    ğŸ“± × × ×œ×¡×•×‘×‘ ××ª ×”×˜×œ×¤×•×Ÿ ×œ××¦×‘ ××•×¤×§×™ (Landscape) ×›×“×™ ×œ×©×—×§ ×‘-CLEFIO
  </div>

  <div class="app-root">
    <div class="phone-frame">
      <div class="star s1"></div>
      <div class="star s2"></div>
      <div class="star s3"></div>
      <div class="star s4"></div>
      <div class="star s5"></div>
      <div class="star s6"></div>

      <!-- ×¦×“ ×©×××œ -->
      <aside class="side-panel">
        <div class="world-title">
          <h1>CLEFIO</h1>
          <div class="world-sub">×¢×•×œ× 1 Â· ×”×—××©×” â€“ ××¤×ª×— ×¡×•×œ</div>
        </div>

        <div class="profile-card">
          <div class="profile-row">
            <span>×¤×¨×•×¤×™×œ × ×’×Ÿ ×¦×¢×™×¨</span>
          </div>
          <div class="profile-row">
            <span class="profile-pill">ğŸŸ¡ ××˜×‘×¢×•×ª: <span id="coins" class="value">0</span></span>
            <span class="profile-pill">ğŸ”¥ ×¨×¦×£: <span id="streak" class="value">0</span></span>
          </div>
          <div class="profile-row">
            <span class="profile-pill">â­ ×¨××”: <span id="level" class="value">1</span></span>
            <span class="profile-pill">XP: <span id="xp" class="value">0</span></span>
          </div>
          <div class="profile-explain">
            ğŸŸ¡ ×”××˜×‘×¢×•×ª × ×¦×‘×¨×•×ª ××ª×©×•×‘×•×ª × ×›×•× ×•×ª ×•××”×™×¨×•×ª
            ×•×™×©××©×• ×‘×¢×ª×™×“ ×œ×¤×ª×™×—×ª ×¢×•×œ××•×ª ×•×¤×¨×¡×™×.
          </div>
        </div>

        <div class="version-label">CLEFIO Â· ×’×¨×¡×ª ×“××• Â· v1.4.1</div>
      </aside>

      <!-- ×¦×“ ×™××™×Ÿ â€“ ×¢×•×œ××•×ª / ××ª×’×¨ -->
      <main class="main-panel">
        <!-- ××¡×š ×¢×•×œ××•×ª -->
        <section id="worldScreen" class="screen active">
          <div class="world-map">
            <div class="island stage1" id="stage1Btn">
              <div class="island-title">×©×œ×‘ 1</div>
              <div class="island-sub">×‘×ª×•×š ×”×—××©×”</div>
            </div>
            <div class="island stage2 locked">
              <div class="island-title">×©×œ×‘ 2</div>
              <div class="island-sub">×‘×ª×•×š ×”×—××©×” ×¢× ×˜×™×™××¨</div>
            </div>
            <div class="island stage3 locked">
              <div class="island-title">×©×œ×‘ 3</div>
              <div class="island-sub">××—×•×¥ ×œ×—××©×”</div>
            </div>
            <div class="island stage4 locked">
              <div class="island-title">×©×œ×‘ 4</div>
              <div class="island-sub">××—×•×¥ ×œ×—××©×” ×¢× ×˜×™×™××¨</div>
            </div>

            <!-- ×‘×•×¢×•×ª ××ª×’×¨×™× -->
            <div class="bubble s1-1 completed" title="××ª×’×¨ 1"><span>1</span></div>
            <div class="bubble s1-2 locked" title="××ª×’×¨ 2"><span>2</span></div>
            <div class="bubble s1-3 locked" title="××ª×’×¨ 3"><span>3</span></div>

            <div class="bubble s2-1 locked"><span>1</span></div>
            <div class="bubble s2-2 locked"><span>2</span></div>
            <div class="bubble s2-3 locked"><span>3</span></div>

            <div class="bubble s3-1 locked"><span>1</span></div>
            <div class="bubble s3-2 locked"><span>2</span></div>
            <div class="bubble s3-3 locked"><span>3</span></div>

            <div class="bubble s4-1 locked"><span>1</span></div>
            <div class="bubble s4-2 locked"><span>2</span></div>
            <div class="bubble s4-3 locked"><span>3</span></div>

            <div class="world-legend">
              <span>â¬¤ ×©×œ×‘×™× Â· ×¢×•×œ× ××¤×ª×— ×¡×•×œ</span>
              <span>×‘×•×¢×•×ª = ××ª×’×¨×™× (3 ×œ×›×œ ×©×œ×‘)</span>
            </div>
          </div>
        </section>

        <!-- ××¡×š ××ª×’×¨ ×“××• -->
        <section id="challengeScreen" class="screen">
          <div class="quiz-screen-header">
            <h2>××ª×’×¨ ×“××• Â· ×©×œ×‘ 1 â€“ ×‘×ª×•×š ×”×—××©×”</h2>
            <button id="backToWorldBtn">â¬… ×—×–×¨×” ×œ×¢×•×œ×</button>
          </div>

          <div class="quiz-main">
            <div class="stats">
              <h3>×¡×˜×˜×™×¡×˜×™×§×” â€” ××ª×’×¨ × ×•×›×—×™</h3>
              <div class="chips">
                <span class="chip">×©××œ×” <span id="questionCount">1</span>/20</span>
                <span class="chip green">× ×›×•× ×•×ª: <span id="correctCount">0</span></span>
                <span class="chip red">×˜×¢×•×™×•×ª: <span id="wrongCount">0</span></span>
                <span class="chip">××—×•×–: <strong id="percent">0%</strong></span>
                <span class="chip timer" id="timerChip">â± <strong id="timer">15.0s</strong></span>
              </div>
              <div class="progress" aria-label="×”×ª×§×“××•×ª ×‘××ª×’×¨">
                <span id="progressBar"></span>
              </div>
            </div>

            <canvas id="staffCanvas" aria-label="×—××©×” ×‘××¤×ª×— ×¡×•×œ"></canvas>

            <p class="muted">×‘×—×¨ ××ª ×©× ×”×ª×• ×‘×¢×–×¨×ª ×”××§×œ×“×ª (×“×• ××¨×›×–×™ ××¡×•××Ÿ ×‘××¨×›×–):</p>
            <div class="piano" id="piano">
              <div class="piano-inner" id="pianoInner">
                <div class="white-keys" id="whiteKeys"></div>
                <div class="black-keys" id="blackKeys"></div>
              </div>
              <div class="middleC-arrow"><span>â¬‡ ×“×• ××¨×›×–×™</span></div>
            </div>

            <div id="feedback"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script>
    const CHALLENGE_CONFIG = {
      region: 'staff',
      timed: true,
      fixedSeconds: 15
    };

    const STORAGE_KEYS = {
      ACTIVE:'clefio_demo_activeChallenge',
      HISTORY:'clefio_demo_history',
      PROFILE:'clefio_demo_profile'
    };

    const saveActiveGame = s => localStorage.setItem(STORAGE_KEYS.ACTIVE, JSON.stringify(s));
    const loadActiveGame = () => { const r = localStorage.getItem(STORAGE_KEYS.ACTIVE); return r ? JSON.parse(r) : null; };
    const clearActiveGame = () => localStorage.removeItem(STORAGE_KEYS.ACTIVE);
    const saveHistory = a => localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(a));
    const loadHistory = () => { const r = localStorage.getItem(STORAGE_KEYS.HISTORY); return r ? JSON.parse(r) : []; };

    function defaultProfile(){
      return {
        coins:0,
        xp:0,
        level:1,
        bestStreak:0,
        totalCorrect:0,
        totalWrong:0,
        lastPlayDate:null,
        dailyStreak:0,
        badges:{}
      };
    }
    function loadProfile(){
      try{
        return Object.assign(defaultProfile(), JSON.parse(localStorage.getItem(STORAGE_KEYS.PROFILE) || '{}'));
      }catch(e){
        return defaultProfile();
      }
    }
    function saveProfile(){ localStorage.setItem(STORAGE_KEYS.PROFILE, JSON.stringify(profile)); }
    let profile = loadProfile();

    const coinsEl = document.getElementById('coins');
    const levelEl = document.getElementById('level');
    const streakEl = document.getElementById('streak');
    const xpEl = document.getElementById('xp');

    function uiProfile(){
      coinsEl.textContent=profile.coins;
      levelEl.textContent=profile.level;
      streakEl.textContent=currentStreak;
      xpEl.textContent=profile.xp;
    }
    function addCoins(n){
      profile.coins=Math.max(0,(profile.coins||0)+n);
      saveProfile();
      uiProfile();
    }
    function addXP(n){
      profile.xp=Math.max(0,(profile.xp||0)+n);
      while(profile.xp>=profile.level*100){
        profile.xp-=profile.level*100;
        profile.level++;
        showToast(`ğŸ… ×¢×œ×™×ª ×¨××”! ×¨××” ${profile.level}`);
        confetti(120);
      }
      saveProfile();
      uiProfile();
    }
    function updateBestStreak(){
      if(profile.bestStreak<currentStreak){
        profile.bestStreak=currentStreak;
        saveProfile();
      }
    }
    function updateDailyStreak(){
      const today=new Date().toDateString();
      if(profile.lastPlayDate!==today){
        const yesterday=new Date(Date.now()-86400000).toDateString();
        profile.dailyStreak = (profile.lastPlayDate===yesterday) ? (profile.dailyStreak||0)+1 : 1;
        profile.lastPlayDate=today;
        saveProfile();
      }
    }

    const toast = document.getElementById('toast');
    const confettiLayer = document.getElementById('confetti');

    function showToast(msg){
      toast.textContent=msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),1600);
    }
    function confetti(N=60){
      confettiLayer.innerHTML='';
      const W=window.innerWidth;
      for(let i=0;i<N;i++){
        const p=document.createElement('i');
        p.style.left=Math.random()*W+'px';
        p.style.background=['#ffd54f','#4fc3f7','#81c784','#ff8a65'][i%4];
        p.style.animationDelay=(Math.random()*0.25)+'s';
        confettiLayer.appendChild(p);
      }
      setTimeout(()=>{ confettiLayer.innerHTML=''; },900);
    }
    function awardBadge(key,label){
      if(profile.badges[key]) return;
      profile.badges[key]={at:Date.now(),label};
      saveProfile();
      showToast(`ğŸ–ï¸ ${label}`);
      confetti(80);
    }

    const worldScreen = document.getElementById('worldScreen');
    const challengeScreen = document.getElementById('challengeScreen');
    const stage1Btn = document.getElementById('stage1Btn');
    const backToWorldBtn = document.getElementById('backToWorldBtn');

    function switchScreen(which){
      if(which==='world'){
        worldScreen.classList.add('active');
        challengeScreen.classList.remove('active');
      }else{
        worldScreen.classList.remove('active');
        challengeScreen.classList.add('active');
      }
    }

    stage1Btn.addEventListener('click',()=>{
      switchScreen('challenge');
      if(!activeGame){
        startNewGame();
      }
    });
    backToWorldBtn.addEventListener('click',()=>switchScreen('world'));

    const canvas = document.getElementById('staffCanvas');
    const ctx = canvas.getContext('2d');
    let DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    let left, right, topLineY, bottomLineY, lineGap, CW, CH;

    function sizeCanvas(){
      canvas.style.width='100%';
      const rect = canvas.getBoundingClientRect();
      const w = Math.min(520, rect.width || 520);
      const h = Math.round(w*0.4); // ×§×˜×Ÿ ×™×•×ª×¨ ×›×“×™ ×œ×¤× ×•×ª ××§×•× ×œ××§×œ×“×ª
      DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      canvas.width = Math.floor(w*DPR);
      canvas.height = Math.floor(h*DPR);
      canvas.style.height = h+'px';
      ctx.setTransform(DPR,0,0,DPR,0,0);
      CW=w; CH=h;
      lineGap = Math.min(Math.max(CH*0.11,18),32);
      const midY = Math.round(CH*0.5);
      topLineY = Math.round(midY-2*lineGap);
      bottomLineY = Math.round(topLineY+4*lineGap);
      left = Math.round(CW*0.14);
      right = Math.round(CW*0.92);
    }

    function yForIndex(i){ return bottomLineY - i*(lineGap/2); }
    function nameForIndex(i){
      const names=['××™','×¤×”','×¡×•×œ','×œ×”','×¡×™','×“×•','×¨×”'];
      const m=((i%7)+7)%7;
      return names[m];
    }

    function indexRangeByChallenge(){
      if(CHALLENGE_CONFIG.region === 'staff'){
        return {min:0,max:8};
      } else {
        return {min:-8,max:16};
      }
    }
    function randomIndex(){
      const {min,max} = indexRangeByChallenge();
      return Math.floor(Math.random()*(max-min+1))+min;
    }

    function drawStaff(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.lineWidth = 1.7;
      ctx.strokeStyle = '#000000';
      for(let i=0;i<5;i++){
        const y = topLineY+i*lineGap;
        ctx.beginPath();
        ctx.moveTo(left,y);
        ctx.lineTo(right,y);
        ctx.stroke();
      }
      ctx.font = Math.round(lineGap*4.2)+'px serif';
      ctx.fillStyle = '#000000';
      ctx.fillText('ğ„', left+lineGap*0.2, topLineY+lineGap*3.25);
    }

    function drawLedgerLinesForIndex(i){
      const cx=(left+right)/2;
      const half=Math.max(18,lineGap*1.1);
      ctx.strokeStyle='#000000';
      if(i>=10){
        for(let li=10; li<=i; li+=2){
          const y=yForIndex(li);
          ctx.beginPath(); ctx.moveTo(cx-half,y); ctx.lineTo(cx+half,y); ctx.stroke();
        }
      }
      if(i<=-2){
        for(let li=-2; li>=i; li-=2){
          const y=yForIndex(li);
          ctx.beginPath(); ctx.moveTo(cx-half,y); ctx.lineTo(cx+half,y); ctx.stroke();
        }
      }
    }

    function drawNoteByIndex(i){
      drawStaff();
      if(i>8||i<0) drawLedgerLinesForIndex(i);
      const y=yForIndex(i);
      const cx=(left+right)/2;
      ctx.beginPath();
      ctx.ellipse(cx,y,lineGap*0.64,lineGap*0.48,-0.35,0,Math.PI*2);
      ctx.fillStyle='#000000';
      ctx.fill();
      const mid=4;
      ctx.beginPath();
      ctx.strokeStyle='#000000';
      if(i>mid){
        ctx.moveTo(cx+lineGap*0.55,y);
        ctx.lineTo(cx+lineGap*0.55,y-lineGap*2);
      } else {
        ctx.moveTo(cx-lineGap*0.55,y);
        ctx.lineTo(cx-lineGap*0.55,y+lineGap*2);
      }
      ctx.stroke();
    }

    function randomNote(){
      const i=randomIndex();
      return { index:i, y:yForIndex(i), name:nameForIndex(i) };
    }

    const piano = document.getElementById('piano');
    const pianoInner = document.getElementById('pianoInner');
    const whiteKeysWrap = document.getElementById('whiteKeys');
    const blackKeysWrap = document.getElementById('blackKeys');

    const whiteOrder=['C','D','E','F','G','A','B'];
    function noteNameFromLetter(L){
      switch(L){
        case 'C':return '×“×•';
        case 'D':return '×¨×”';
        case 'E':return '××™';
        case 'F':return '×¤×”';
        case 'G':return '×¡×•×œ';
        case 'A':return '×œ×”';
        case 'B':return '×¡×™';
      }
    }

    function buildPiano(){
      whiteKeysWrap.innerHTML='';
      blackKeysWrap.innerHTML='';
      const whites=[];
      for(let o=4;o<=5;o++){
        for(const L of whiteOrder){ whites.push({letter:L, octave:o}); }
      }
      whites.forEach(w=>{
        const div=document.createElement('div');
        div.className='wkey';
        const name=noteNameFromLetter(w.letter);
        div.dataset.letter=w.letter;
        div.dataset.octave=w.octave;
        div.dataset.name=name;
        div.addEventListener('click',()=>{
          if(!timerControls.canAnswer) return;
          recordAndAdvance(name===currentNote.name);
        });
        whiteKeysWrap.appendChild(div);
      });

      requestAnimationFrame(()=>{
        placeBlackKeys(whites);
        centerMiddleC();
      });
    }

    function placeBlackKeys(whites){
      blackKeysWrap.innerHTML='';
      const pianoRect=piano.getBoundingClientRect();
      const whiteElems=[...whiteKeysWrap.children];
      if(whiteElems.length!==14) return;
      const centers=whiteElems.map(el=>{
        const r=el.getBoundingClientRect();
        return {left:r.left,right:r.right,center:(r.left+r.right)/2,width:r.width};
      });
      const whitesSeq=whites.map(w=>w.letter);
      const blackIdx=[];
      whitesSeq.forEach((L,i)=>{
        if(L==='C'||L==='D'||L==='F'||L==='G'||L==='A'){
          if(i+1<centers.length) blackIdx.push(i);
        }
      });
      const blackW=Math.max(14,Math.round(centers[0].width*0.6));
      blackIdx.forEach(i=>{
        const cx=(centers[i].right+centers[i+1].left)/2 - pianoRect.left;
        const b=document.createElement('div');
        b.className='bkey';
        b.style.left=cx+'px';
        b.style.width=blackW+'px';
        blackKeysWrap.appendChild(b);
      });
    }

    function centerMiddleC(){
      const whiteElems=[...whiteKeysWrap.children];
      if(whiteElems.length!==14) return;
      const pianoRect=piano.getBoundingClientRect();
      let middleKey=null;
      whiteElems.forEach(el=>{
        if(el.dataset.letter==='C' && el.dataset.octave==='4') middleKey=el;
      });
      if(!middleKey) return;
      const keyRect=middleKey.getBoundingClientRect();
      const keyCenter=(keyRect.left+keyRect.right)/2;
      const pianoCenter=pianoRect.left+pianoRect.width/2;
      const delta=pianoCenter-keyCenter;
      const current=Number((pianoInner.dataset.tx||0));
      const newTx=current+delta;
      pianoInner.style.transform=`translateX(${newTx}px)`;
      pianoInner.dataset.tx=newTx;
    }

    let audioCtx=null;
    let soundEnabled=true;
    let convolver=null;

    function ensureAudio(){
      if(!audioCtx){
        try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
        catch(e){ console.warn('AudioContext failed',e); }
      }
      if(audioCtx && !convolver){
        const rev=audioCtx.createConvolver();
        rev.buffer=makeReverbImpulse(0.7,2.9);
        rev.connect(audioCtx.destination);
        convolver=rev;
      }
    }

    function makeReverbImpulse(seconds=0.6,decay=2.5){
      const rate=audioCtx.sampleRate;
      const len=Math.max(1,Math.floor(rate*seconds));
      const impulse=audioCtx.createBuffer(2,len,rate);
      for(let ch=0;ch<2;ch++){
        const data=impulse.getChannelData(ch);
        for(let i=0;i<len;i++){
          const t=i/len;
          const pink=(Math.random()*2-1)*(0.7+0.3*Math.random());
          data[i]=pink*Math.pow(1-t,decay);
        }
      }
      return impulse;
    }

    function noteIndexToSemitones(i){
      const steps=[1,2,2,2,1,2,2];
      if(i===0) return 0;
      let s=0; let idx=0;
      if(i>0){
        for(let k=1;k<=i;k++){ s+=steps[idx]; idx=(idx+1)%7; }
        return s;
      } else {
        idx=(7+((i%7)+7)%7-1)%7;
        for(let k=-1;k>=i;k--){ s-=steps[(idx+1)%7]; idx=(idx+6)%7; }
        return s;
      }
    }

    function freqForIndex(i){
      const base=329.628;
      const n=noteIndexToSemitones(i);
      return base*Math.pow(2,n/12);
    }

    function playPianoSynth(freq,dur=0.9){
      if(!soundEnabled) return;
      ensureAudio(); if(!audioCtx) return;
      const now=audioCtx.currentTime;
      const g=audioCtx.createGain();
      g.gain.setValueAtTime(0,now);
      g.gain.linearRampToValueAtTime(1.0,now+0.006);
      g.gain.exponentialRampToValueAtTime(0.55,now+0.18);
      g.gain.exponentialRampToValueAtTime(0.0001,now+dur);
      const pan=audioCtx.createStereoPanner();
      pan.pan.setValueAtTime((Math.random()*0.3-0.15),now);
      const presence=audioCtx.createBiquadFilter();
      presence.type='peaking';
      presence.frequency.value=2500;
      presence.Q.value=0.7;
      presence.gain.value=1.2;
      const hs=audioCtx.createBiquadFilter();
      hs.type='highshelf';
      hs.frequency.value=5200;
      hs.gain.value=-1.2;
      g.connect(presence).connect(hs).connect(pan).connect(audioCtx.destination);
      const wet=audioCtx.createGain();
      wet.gain.value=0.22;
      hs.connect(wet);
      if(convolver) wet.connect(convolver);

      const nbuf=audioCtx.createBuffer(1,Math.floor(audioCtx.sampleRate*0.018),audioCtx.sampleRate);
      const ndata=nbuf.getChannelData(0);
      for(let i=0;i<ndata.length;i++){
        ndata[i]=(Math.random()*2-1)*(1-i/ndata.length);
      }
      const nsrc=audioCtx.createBufferSource();
      nsrc.buffer=nbuf;
      const nhp=audioCtx.createBiquadFilter();
      nhp.type='highpass';
      nhp.frequency.value=1500;
      nhp.Q.value=0.9;
      nsrc.connect(nhp).connect(g);

      const B=Math.min(0.00035,0.00018+(freq-130)/4000*0.00012);
      const partialAmp=[1.00,0.58,0.34,0.22,0.15,0.11];
      for(let n=1;n<=partialAmp.length;n++){
        const o=audioCtx.createOscillator();
        o.type=(n<=2?'sine':(n<=4?'triangle':'sine'));
        const inharm=(n+B*Math.pow(n,3))/n;
        o.frequency.setValueAtTime(freq*n*inharm,now);
        const pg=audioCtx.createGain();
        const a=partialAmp[n-1];
        const tail=Math.max(0.18,0.9*(0.85/Math.pow(n,0.45)));
        pg.gain.setValueAtTime(0,now);
        pg.gain.linearRampToValueAtTime(a,now+0.006+n*0.002);
        pg.gain.exponentialRampToValueAtTime(0.0001,now+tail);
        o.connect(pg).connect(g);
        o.start(now);
        o.stop(now+tail+0.05);
      }

      const oF=audioCtx.createOscillator();
      oF.type='sine';
      oF.frequency.setValueAtTime(freq,now);
      const oB=audioCtx.createOscillator();
      oB.type='sine';
      oB.frequency.setValueAtTime(freq,now);
      oB.detune.setValueAtTime(-7,now);
      const gF=audioCtx.createGain();
      gF.gain.setValueAtTime(0.22,now);
      const gB=audioCtx.createGain();
      gB.gain.setValueAtTime(0.12,now);
      oF.connect(gF).connect(g);
      oB.connect(gB).connect(g);
      oF.start(now);
      oB.start(now);
      oF.stop(now+0.5);
      oB.stop(now+0.45);

      nsrc.start(now);
    }

    function playGrand(freq,dur=1.2){
      playPianoSynth(freq,dur);
    }
    function playSquirrel(dur=0.2){
      if(!soundEnabled) return;
      ensureAudio(); if(!audioCtx) return;
      const now=audioCtx.currentTime;
      const bufferSize=audioCtx.sampleRate*dur;
      const buffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++){
        data[i]=(Math.random()*2-1)*Math.exp(-i/(bufferSize*0.6));
      }
      const src=audioCtx.createBufferSource();
      src.buffer=buffer;
      const bp=audioCtx.createBiquadFilter();
      bp.type='bandpass';
      bp.frequency.setValueAtTime(1800,now);
      bp.Q.value=4;
      const g=audioCtx.createGain();
      g.gain.setValueAtTime(0.9,now);
      g.gain.exponentialRampToValueAtTime(0.0001,now+dur);
      src.connect(bp).connect(g).connect(audioCtx.destination);
      src.start(now);
    }

    const TOTAL_QUESTIONS = 20;
    let activeGame = null;
    let history = loadHistory();
    let currentNote;
    let questionStartHR = 0;
    let currentStreak=0;

    const qCount = document.getElementById('questionCount');
    const correctCount = document.getElementById('correctCount');
    const wrongCount = document.getElementById('wrongCount');
    const percentSpan = document.getElementById('percent');
    const timerSpan = document.getElementById('timer');
    const timerChip = document.getElementById('timerChip');
    const progressBar = document.getElementById('progressBar');
    const feedback = document.getElementById('feedback');

    let timerInterval=null;
    const timerControls={
      running:false,
      remaining:0,
      duration:CHALLENGE_CONFIG.fixedSeconds,
      infinite:!CHALLENGE_CONFIG.timed,
      canAnswer:false
    };

    function updateTimerUI(){
      if(!CHALLENGE_CONFIG.timed){
        timerChip.style.display='none';
      }else{
        timerChip.style.display='inline-flex';
        timerSpan.textContent = timerControls.remaining.toFixed(1)+'s';
      }
    }
    function pauseTimer(){
      if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
      timerControls.running=false;
      updateTimerUI();
    }
    function resetAndMaybeStartTimer(){
      if(!CHALLENGE_CONFIG.timed){
        timerControls.infinite=true;
        timerControls.canAnswer=true;
        timerControls.running=false;
        timerSpan.textContent='â€”';
        return;
      }
      timerControls.infinite=false;
      timerControls.duration=CHALLENGE_CONFIG.fixedSeconds;
      timerControls.remaining=timerControls.duration;
      timerControls.canAnswer=true;
      updateTimerUI();
      const start=performance.now();
      let lastRemaining=timerControls.remaining;
      timerControls.running=true;
      timerInterval=setInterval(()=>{
        const elapsed=(performance.now()-start)/1000;
        timerControls.remaining=Math.max(0,lastRemaining-elapsed);
        updateTimerUI();
        if(timerControls.remaining<=0){
          pauseTimer();
          recordAndAdvance(false);
        }
      },100);
    }

    function calcPercent(c,w){ const t=c+w; return t? Math.round((c/t)*100):0; }
    function formatDT(iso){ try{ return new Date(iso).toLocaleString('he-IL',{hour12:false}); }catch(e){ return iso; } }

    function pickAndDraw(){
      currentNote=randomNote();
      drawNoteByIndex(currentNote.index);
      if(activeGame){
        qCount.textContent=activeGame.currentQuestion;
        correctCount.textContent=activeGame.correct;
        wrongCount.textContent=activeGame.wrong;
        percentSpan.textContent=calcPercent(activeGame.correct,activeGame.wrong)+'%';
        progressBar.style.width=((activeGame.currentQuestion-1)/TOTAL_QUESTIONS*100)+'%';
      }
      feedback.textContent='';
      feedback.classList.remove('correct','wrong');
      resetAndMaybeStartTimer();
      questionStartHR=performance.now();
    }

    function recordAndAdvance(ok){
      pauseTimer();
      if(!activeGame) return;
      const elapsedSec=Math.max(0,(performance.now()-questionStartHR)/1000);

      if(navigator.vibrate){ navigator.vibrate(ok?30:[20,50,20]); }

      if(ok){
        currentStreak++;
        updateBestStreak();
        addXP(10);
        let coinsToAdd=1;
        if(CHALLENGE_CONFIG.timed && elapsedSec<=Math.max(1.2,timerControls.duration*0.4)){
          coinsToAdd+=1;
          awardBadge('speedster','××”×™×¨ ×›×”×¨×£ ×¢×™×Ÿ!');
        }
        if(currentStreak>=3){
          coinsToAdd+=1;
          showToast(`ğŸ”¥ ×§×•××‘×• x${currentStreak}! +${coinsToAdd} ××˜×‘×¢×•×ª`);
        }
        addCoins(coinsToAdd);
        profile.totalCorrect++;
        saveProfile();
        ensureAudio();
        playGrand(freqForIndex(currentNote.index));
        feedback.textContent='× ×›×•×Ÿ ×××•×“! ğŸ‰';
        feedback.classList.add('correct');
        feedback.classList.remove('wrong');
        confetti(35);
      } else {
        currentStreak=0;
        profile.totalWrong++;
        saveProfile();
        ensureAudio();
        playSquirrel(0.2);
        feedback.textContent=`×œ× × ×›×•×Ÿ. ×”×ª×©×•×‘×” ×”×™× ${currentNote.name}.`;
        feedback.classList.add('wrong');
        feedback.classList.remove('correct');
      }

      if(activeGame.currentQuestion < TOTAL_QUESTIONS){
        if(ok) activeGame.correct++; else activeGame.wrong++;
        activeGame.currentQuestion++;
        saveActiveGame(activeGame);
        correctCount.textContent=activeGame.correct;
        wrongCount.textContent=activeGame.wrong;
        percentSpan.textContent=calcPercent(activeGame.correct,activeGame.wrong)+'%';
        progressBar.style.width=((activeGame.currentQuestion-1)/TOTAL_QUESTIONS*100)+'%';
        setTimeout(()=>{ pickAndDraw(); uiProfile(); },1500);
      } else {
        if(ok) activeGame.correct++; else activeGame.wrong++;
        const finishedAt=new Date().toISOString();
        const percent=calcPercent(activeGame.correct,activeGame.wrong);
        history=(history||[]);
        history.push({id:activeGame.id, finishedAt, correct:activeGame.correct, wrong:activeGame.wrong, percent, title:formatDT(finishedAt)});
        saveHistory(history);

        if(activeGame.correct>=18) awardBadge('almostPerfect','×›××¢×˜ ××•×©×œ×! 18/20+');
        if(activeGame.wrong===0 && activeGame.correct===20) awardBadge('perfect','××•×©×œ×! 20/20');

        clearActiveGame();
        activeGame=null;
        showToast('××ª×’×¨ ×“××• ×”×•×©×œ×! ğŸµ');
        uiProfile();
      }
    }

    function startNewGame(){
      if(activeGame){
        alert('×›×‘×¨ ×™×© ××ª×’×¨ ×¤×¢×™×œ ×©×œ ×”×“××•. ×¡×™×™× ××•×ª×• ××• ××—×§ ××”Ö¾LocalStorage.');
        return;
      }
      activeGame={ id:'demo_'+Date.now(), startedAt:new Date().toISOString(), currentQuestion:1, correct:0, wrong:0 };
      saveActiveGame(activeGame);
      currentStreak=0;
      updateDailyStreak();
      pickAndDraw();
      uiProfile();
      awardBadge('firstDemo','××ª×’×¨ ×”×“××• ×”×¨××©×•×Ÿ ×©×œ×š!');
    }

    function resumeActiveIfAny(){
      const stored=loadActiveGame();
      if(stored && stored.currentQuestion<=TOTAL_QUESTIONS){
        activeGame=stored;
        pickAndDraw();
      }
    }

    ['click','keydown','touchstart'].forEach(ev=>{
      document.addEventListener(ev,()=>{
        ensureAudio();
        if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
      },{once:true});
    });

    (function selfTests(){
      try{
        sizeCanvas();
        buildPiano();
        console.assert(typeof yForIndex==='function','yForIndex fn');
        console.assert(typeof randomNote==='function','randomNote fn');
      }catch(err){
        console.error('Self tests failed:',err);
      }
    })();

    function init(){
      sizeCanvas();
      buildPiano();
      uiProfile();
      resumeActiveIfAny();
    }

    window.addEventListener('resize',()=>{
      sizeCanvas();
      buildPiano();
      if(activeGame) pickAndDraw();
    });

    init();
  </script>
</body>
</html>
