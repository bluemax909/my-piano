<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>CLEFIO â€“ ×¢×•×œ× ×”×—××©×” + ××ª×’×¨ ×“××•</title>
  <style>
    :root{
      --ink:#eaf2ff;
      --accent:#ffeb3b;
      --bg1:#040715;
      --gold:#f4b400;
      --green:#66bb6a;
      --red:#ef5350;
      --bubble-blue:#8fd3ff;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      min-height:100vh;
      font-family:system-ui,-apple-system,"Segoe UI","Alef","Rubik",sans-serif;
      background:#000;
      color:var(--ink);
      overflow-x:hidden;
      direction:rtl;
    }

    .rotate-warning{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:#000;
      color:#fff;
      z-index:9999;
      text-align:center;
      padding:20px;
      font-size:18px;
    }
    @media (orientation:portrait){
      .rotate-warning{ display:flex; }
      .app-root{ display:none; }
    }

    .app-root{
      width:100vw;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#283593 0,#040715 55%,#000 100%);
    }

    .phone-frame{
      width:100vw;
      height:100vh;
      max-width:900px;
      max-height:520px;
      padding:8px 10px;
      border-radius:26px;
      background:linear-gradient(145deg,rgba(255,255,255,0.06),rgba(0,0,0,0.7));
      box-shadow:
        0 18px 40px rgba(0,0,0,0.85),
        0 0 40px rgba(0,150,255,0.18);
      border:1px solid rgba(255,255,255,0.16);
      position:relative;
      overflow:hidden;
      backdrop-filter:blur(20px);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    @media (max-width:720px){
      .phone-frame{
        border-radius:0;
        max-width:none;
        max-height:none;
      }
    }

    .star{
      position:absolute;
      width:3px;
      height:3px;
      border-radius:50%;
      background:radial-gradient(circle,#ffffff,#90caf9);
      opacity:.55;
      filter:blur(0.2px);
      pointer-events:none;
    }
    .star.s1{ top:6%; right:16%; }
    .star.s2{ top:14%; left:10%; }
    .star.s3{ top:34%; right:22%; }
    .star.s4{ top:58%; left:20%; }
    .star.s5{ top:78%; right:32%; }
    .star.s6{ top:30%; left:40%; }

    /* ===== ×˜×•×¤Ö¾×‘×¨ ===== */
    .top-bar{
      position:relative;
      z-index:2;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:4px 6px;
      border-radius:16px;
      background:rgba(2,6,23,0.9);
      border:1px solid rgba(255,255,255,0.18);
      font-size:12px;
    }
    .top-bar-left h1{
      margin:0;
      font-size:18px;
      color:#fffde7;
      text-shadow:0 0 8px rgba(255,255,255,0.5);
    }
    .top-bar-left small{
      display:block;
      font-size:10px;
      color:#c5cfdd;
    }
    .top-bar-right{
      font-size:10px;
      color:#b0bec5;
      text-align:left;
    }
    .version-label{
      font-size:9px;
      color:#90a4ae;
    }

    /* ===== ××¡×›×™× ===== */
    .main-panel{
      position:relative;
      z-index:2;
      flex:1;
      min-height:0;
      background:rgba(5,10,30,0.9);
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.18);
      padding:6px;
      overflow-y:auto;
      overflow-x:hidden;
      display:flex;
      flex-direction:column;
    }
    .screen{
      width:100%;
      height:100%;
      display:none;
    }
    .screen.active{
      display:flex;
      flex-direction:column;
    }

    /* ===== ××¡×š ×¢×•×œ××•×ª ===== */
    .world-map{
      position:relative;
      flex:1;
      border-radius:14px;
      overflow:hidden;
      background:radial-gradient(circle at top,#1a237e 0,#040715 45%,#000 100%);
      border:1px solid rgba(255,255,255,0.15);
    }
    .world-map::before{
      content:"";
      position:absolute;
      inset:20% 8%;
      border-radius:999px;
      border:2px dashed rgba(144,202,249,0.9);
      box-shadow:0 0 12px rgba(144,202,249,0.7);
      opacity:0.75;
      transform:skewX(-8deg);
    }

    .island{
      position:absolute;
      width:90px;
      height:90px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 20%,#fff9c4,#fdd835,#f9a825);
      box-shadow:0 0 0 4px rgba(255,255,255,0.7),0 10px 18px rgba(0,0,0,0.7);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      cursor:pointer;
      transition:transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
      z-index:3;
    }
    .island:hover{
      transform:translateY(-4px) scale(1.03);
      box-shadow:0 0 0 5px rgba(255,255,255,0.9),0 16px 24px rgba(0,0,0,0.85);
    }
    .island.locked{
      opacity:0.35;
      cursor:default;
    }
    .island-title{
      font-size:11px;
      font-weight:700;
      color:#3e2723;
    }
    .island-sub{
      font-size:10px;
      color:#4e342e;
    }
    .island.stage1{ top:60%; left:15%; transform:translate(-50%,-50%); }
    .island.stage2{ top:35%; left:38%; transform:translate(-50%,-50%); }
    .island.stage3{ top:65%; left:62%; transform:translate(-50%,-50%); }
    .island.stage4{ top:40%; left:85%; transform:translate(-50%,-50%); }

    .bubble{
      position:absolute;
      width:34px;
      height:34px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 20%,#e1f5fe,#81d4fa,#0288d1);
      box-shadow:0 0 0 2px rgba(255,255,255,0.9),0 4px 8px rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      color:#01579b;
      font-weight:700;
      z-index:2;
      transition:transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease;
    }
    .bubble span{ transform:translateY(-1px); }
    .bubble.locked{
      opacity:0.3;
      box-shadow:0 0 0 2px rgba(255,255,255,0.4),0 2px 4px rgba(0,0,0,0.5);
    }
    .bubble.completed{
      background:radial-gradient(circle at 30% 20%,#fff9c4,#ffe082,#ffb300);
      color:#5d4037;
    }
    .bubble.s1-1{ top:40%; left:18%; }
    .bubble.s1-2{ top:30%; left:10%; }
    .bubble.s1-3{ top:52%; left:8%; }

    .bubble.s2-1{ top:22%; left:40%; }
    .bubble.s2-2{ top:32%; left:48%; }
    .bubble.s2-3{ top:44%; left:44%; }

    .bubble.s3-1{ top:45%; left:64%; }
    .bubble.s3-2{ top:30%; left:56%; }
    .bubble.s3-3{ top:68%; left:56%; }

    .bubble.s4-1{ top:24%; left:86%; }
    .bubble.s4-2{ top:36%; left:76%; }
    .bubble.s4-3{ top:56%; left:88%; }

    .world-legend{
      position:absolute;
      bottom:4px;
      left:8px;
      right:8px;
      display:flex;
      justify-content:space-between;
      font-size:10px;
      color:#c5cae9;
      z-index:4;
    }

    /* ===== ××¡×š ××ª×’×¨ ===== */
    .quiz-main{
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      padding:2px 2px 4px;
      gap:3px;
    }

    .quiz-top-row{
      width:100%;
      max-width:780px;
      display:flex;
      justify-content:flex-start;
      margin-bottom:2px;
    }
    .quiz-top-row button{
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.4);
      background:rgba(0,0,0,0.35);
      color:#f5f5f5;
      cursor:pointer;
      font-size:11px;
    }

    .stats{
      width:100%;
      max-width:780px;
      background:rgba(9,16,39,0.9);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.18);
      padding:3px 4px;
      font-size:9px;
    }
    .stats h3{
      margin:0 0 3px;
      font-size:10px;
      color:#e3f2fd;
      text-align:center;
    }
    .chips{
      display:flex;
      gap:3px;
      justify-content:center;
      flex-wrap:wrap;
    }
    .chip{
      padding:2px 5px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.25);
      font-size:9px;
      white-space:nowrap;
    }
    .chip.green{ border-color:#4caf50; color:#c8e6c9; font-weight:600; }
    .chip.red{ border-color:#f44336; color:#ffcdd2; font-weight:600; }
    .chip.timer{ border-color:#1976d2; color:#bbdefb; font-weight:600; }
    .chip.timer strong{
      display:inline-block;
      min-width:48px;
      text-align:center;
      font-variant-numeric:tabular-nums;
    }

    .progress{
      width:100%;
      height:6px;
      background:#1b2235;
      border-radius:999px;
      overflow:hidden;
      box-shadow:inset 0 1px 2px rgba(0,0,0,.5);
      margin-top:3px;
    }
    .progress > span{
      display:block;
      height:100%;
      width:0%;
      background:linear-gradient(90deg,#4caf50,#81c784);
      transition:width .3s ease;
    }

    canvas{
      border:1px solid rgba(255,255,255,0.7);
      background:#ffffff;
      margin:3px auto 3px;
      display:block;
      width:100%;
      max-width:780px;
      height:auto;
      border-radius:8px;
    }

    .piano{
      position:relative;
      width:100%;
      max-width:560px;    /* ×”×•×§×˜×Ÿ ~30% */
      aspect-ratio:31/7;
      margin:2px auto 0;
      user-select:none;
      direction:ltr;
    }
    .white-keys{
      position:absolute;
      inset:0;
      display:grid;
      grid-template-columns:repeat(14,1fr);
      column-gap:0;
      align-items:end;
      justify-items:stretch;
      padding:0;
      direction:ltr;
    }
    .wkey{
      height:100%;
      background:#ffffff;
      border:1px solid #b0bec5;
      border-radius:6px;
      position:relative;
      cursor:pointer;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      font-weight:700;
      font-size:10px;
    }
    .wkey:active{ filter:brightness(0.95); }
    .black-keys{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .bkey{
      position:absolute;
      height:72%;
      background:#111;
      border:1px solid #333;
      border-radius:4px;
      transform:translateX(-50%);
      z-index:10;
    }

    /* ×—×¥ ×“×• ××¨×›×–×™ â€“ ×¢×›×©×™×• ×ª××™×“ ×‘×××¦×¢ ×”××§×œ×“×ª, ×¢× ×—×¥ ×›×œ×¤×™ ××¢×œ×” */
    .middleC-arrow{
      position:absolute;
      bottom:-20px;
      left:50%;
      transform:translateX(-50%);
      height:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
    }
    .middleC-arrow span{
      font-size:11px;
      color:#e0e0e0;
      background:rgba(0,0,0,0.6);
      padding:2px 8px;
      border-radius:999px;
    }

    #feedback{
      font-weight:bold;
      margin-top:2px;
      min-height:20px;
      font-size:12px;
      text-align:center;
    }
    .correct{ color:var(--green); }
    .wrong{ color:var(--red); }

    .toast{
      position:fixed;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      background:#ffffff;
      border:2px solid #ffd54f;
      border-radius:14px;
      padding:6px 10px;
      box-shadow:0 6px 16px rgba(0,0,0,.25);
      display:none;
      align-items:center;
      gap:8px;
      z-index:1000;
      font-size:12px;
      color:#333;
    }
    .toast.show{
      display:flex;
      animation:pop .4s ease;
    }
    @keyframes pop{
      0%{ transform:translate(-50%,-8px) scale(.9); opacity:0; }
      100%{ transform:translate(-50%,0) scale(1); opacity:1; }
    }

    .confetti{
      pointer-events:none;
      position:fixed;
      inset:0;
      overflow:hidden;
      z-index:999;
    }
    .confetti i{
      position:absolute;
      width:8px;
      height:14px;
      background:var(--gold);
      opacity:.9;
      transform:rotate(15deg);
      animation:fall 900ms ease-out forwards;
    }
    @keyframes fall{
      to{ transform:translateY(120vh) rotate(360deg); opacity:0; }
    }
  </style>
</head>
<body>
  <div class="rotate-warning">
    ğŸ“± × × ×œ×¡×•×‘×‘ ××ª ×”×˜×œ×¤×•×Ÿ ×œ××¦×‘ ××•×¤×§×™ (Landscape) ×›×“×™ ×œ×©×—×§ ×‘-CLEFIO
  </div>

  <div class="app-root">
    <div class="phone-frame">
      <div class="star s1"></div>
      <div class="star s2"></div>
      <div class="star s3"></div>
      <div class="star s4"></div>
      <div class="star s5"></div>
      <div class="star s6"></div>

      <header class="top-bar">
        <div class="top-bar-left">
          <h1>CLEFIO</h1>
          <small>×¢×•×œ× 1 Â· ×”×—××©×” â€“ ××¤×ª×— ×¡×•×œ</small>
        </div>
        <div class="top-bar-right">
          <div>××ª×’×¨ ×“××• â€“ ×©×œ×‘ 1 ×‘×ª×•×š ×”×—××©×”</div>
          <div class="version-label">v1.5.4 Â· ×“××•</div>
        </div>
      </header>

      <main class="main-panel">
        <!-- ××¡×š ×¢×•×œ××•×ª -->
        <section id="worldScreen" class="screen active">
          <div class="world-map">
            <div class="island stage1" id="stage1Btn">
              <div class="island-title">×©×œ×‘ 1</div>
              <div class="island-sub">×‘×ª×•×š ×”×—××©×”</div>
            </div>
            <div class="island stage2 locked">
              <div class="island-title">×©×œ×‘ 2</div>
              <div class="island-sub">×‘×ª×•×š ×”×—××©×” ×¢× ×˜×™×™××¨</div>
            </div>
            <div class="island stage3 locked">
              <div class="island-title">×©×œ×‘ 3</div>
              <div class="island-sub">××—×•×¥ ×œ×—××©×”</div>
            </div>
            <div class="island stage4 locked">
              <div class="island-title">×©×œ×‘ 4</div>
              <div class="island-sub">××—×•×¥ ×œ×—××©×” ×¢× ×˜×™×™××¨</div>
            </div>

            <!-- ×‘×•×¢×•×ª ××ª×’×¨×™× -->
            <div class="bubble s1-1 completed" title="××ª×’×¨ 1"><span>1</span></div>
            <div class="bubble s1-2 locked"    title="××ª×’×¨ 2"><span>2</span></div>
            <div class="bubble s1-3 locked"    title="××ª×’×¨ 3"><span>3</span></div>

            <div class="bubble s2-1 locked"><span>1</span></div>
            <div class="bubble s2-2 locked"><span>2</span></div>
            <div class="bubble s2-3 locked"><span>3</span></div>

            <div class="bubble s3-1 locked"><span>1</span></div>
            <div class="bubble s3-2 locked"><span>2</span></div>
            <div class="bubble s3-3 locked"><span>3</span></div>

            <div class="bubble s4-1 locked"><span>1</span></div>
            <div class="bubble s4-2 locked"><span>2</span></div>
            <div class="bubble s4-3 locked"><span>3</span></div>

            <div class="world-legend">
              <span>â¬¤ ×©×œ×‘×™× Â· ×¢×•×œ× ××¤×ª×— ×¡×•×œ</span>
              <span>×‘×•×¢×•×ª = ××ª×’×¨×™× (3 ×œ×›×œ ×©×œ×‘)</span>
            </div>
          </div>
        </section>

        <!-- ××¡×š ××ª×’×¨ ×“××• -->
        <section id="challengeScreen" class="screen">
          <div class="quiz-main">
            <div class="quiz-top-row">
              <button id="backToWorldBtn">â¬… ×—×–×¨×” ×œ×¢×•×œ×</button>
            </div>

            <div class="stats">
              <h3>×¡×˜×˜×™×¡×˜×™×§×” â€” ××ª×’×¨ × ×•×›×—×™</h3>
              <div class="chips">
                <span class="chip">×©××œ×” <span id="questionCount">1</span>/20</span>
                <span class="chip green">× ×›×•× ×•×ª: <span id="correctCount">0</span></span>
                <span class="chip red">×˜×¢×•×™×•×ª: <span id="wrongCount">0</span></span>
                <span class="chip">××—×•×–: <strong id="percent">0%</strong></span>
                <span class="chip timer" id="timerChip">â± <strong id="timer">15.0s</strong></span>
              </div>
              <div class="progress" aria-label="×”×ª×§×“××•×ª ×‘××ª×’×¨">
                <span id="progressBar"></span>
              </div>
            </div>

            <canvas id="staffCanvas" aria-label="×—××©×” ×‘××¤×ª×— ×¡×•×œ"></canvas>

            <div class="piano" id="piano">
              <div class="white-keys" id="whiteKeys"></div>
              <div class="black-keys" id="blackKeys"></div>
              <div class="middleC-arrow"><span>â¬† ×“×• ××¨×›×–×™</span></div>
            </div>

            <div id="feedback"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="confetti" class="confetti" aria-hidden="true"></div>

  <script>
    const CHALLENGE_CONFIG = {
      region: 'staff',
      timed: true,
      fixedSeconds: 15
    };

    const STORAGE_KEYS = {
      ACTIVE:'clefio_demo_activeChallenge',
      HISTORY:'clefio_demo_history'
    };
    const saveActiveGame = s => localStorage.setItem(STORAGE_KEYS.ACTIVE, JSON.stringify(s));
    const loadActiveGame = () => { const r = localStorage.getItem(STORAGE_KEYS.ACTIVE); return r ? JSON.parse(r) : null; };
    const clearActiveGame = () => localStorage.removeItem(STORAGE_KEYS.ACTIVE);
    const saveHistory = a => localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(a));
    const loadHistory = () => { const r = localStorage.getItem(STORAGE_KEYS.HISTORY); return r ? JSON.parse(r) : []; };

    const worldScreen = document.getElementById('worldScreen');
    const challengeScreen = document.getElementById('challengeScreen');
    const stage1Btn = document.getElementById('stage1Btn');
    const backToWorldBtn = document.getElementById('backToWorldBtn');

    function switchScreen(which){
      if(which==='world'){
        worldScreen.classList.add('active');
        challengeScreen.classList.remove('active');
      }else{
        worldScreen.classList.remove('active');
        challengeScreen.classList.add('active');
      }
    }

    stage1Btn.addEventListener('click',()=>{
      switchScreen('challenge');
      // ××•×•×“××™× ×©×”××¡×š ×›×‘×¨ ×’×œ×•×™ ×œ×¤× ×™ ××“×™×“×•×ª
      setTimeout(()=>{
        sizeCanvas();
        buildPiano();
        if(!activeGame){
          startNewGame();
        }else{
          pickAndDraw();
        }
      },0);
    });
    backToWorldBtn.addEventListener('click',()=>switchScreen('world'));

    // ===== ×—××©×” =====
    const canvas = document.getElementById('staffCanvas');
    const ctx = canvas.getContext('2d');
    let DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
    let left, right, topLineY, bottomLineY, lineGap, CW, CH;

    function sizeCanvas(){
      canvas.style.width='100%';
      const rect = canvas.getBoundingClientRect();
      const w = Math.min(780, rect.width || 780);
      const h = Math.round(w*0.22);
      DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
      canvas.width = Math.floor(w*DPR);
      canvas.height = Math.floor(h*DPR);
      canvas.style.height = h+'px';
      ctx.setTransform(DPR,0,0,DPR,0,0);
      CW=w; CH=h;
      lineGap = Math.min(Math.max(CH*0.11,16),26);
      const midY = Math.round(CH*0.5);
      topLineY = Math.round(midY-2*lineGap);
      bottomLineY = Math.round(topLineY+4*lineGap);
      left = Math.round(CW*0.14);
      right = Math.round(CW*0.92);
    }

    function yForIndex(i){ return bottomLineY - i*(lineGap/2); }
    function nameForIndex(i){
      const names=['××™','×¤×”','×¡×•×œ','×œ×”','×¡×™','×“×•','×¨×”'];
      const m=((i%7)+7)%7;
      return names[m];
    }

    function indexRangeByChallenge(){ return {min:0,max:8}; }
    function randomIndex(){
      const {min,max} = indexRangeByChallenge();
      return Math.floor(Math.random()*(max-min+1))+min;
    }

    function drawStaff(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.lineWidth = 1.7;
      ctx.strokeStyle = '#000000';
      for(let i=0;i<5;i++){
        const y = topLineY+i*lineGap;
        ctx.beginPath();
        ctx.moveTo(left,y);
        ctx.lineTo(right,y);
        ctx.stroke();
      }
      ctx.font = Math.round(lineGap*4.0)+'px serif';
      ctx.fillStyle = '#000000';
      ctx.fillText('ğ„', left+lineGap*0.2, topLineY+lineGap*3.1);
    }

    function drawLedgerLinesForIndex(i){
      const cx=(left+right)/2;
      const half=Math.max(18,lineGap*1.1);
      ctx.strokeStyle='#000000';
      if(i>=10){
        for(let li=10; li<=i; li+=2){
          const y=yForIndex(li);
          ctx.beginPath(); ctx.moveTo(cx-half,y); ctx.lineTo(cx+half,y); ctx.stroke();
        }
      }
      if(i<=-2){
        for(let li=-2; li>=i; li-=2){
          const y=yForIndex(li);
          ctx.beginPath(); ctx.moveTo(cx-half,y); ctx.lineTo(cx+half,y); ctx.stroke();
        }
      }
    }

    function drawNoteByIndex(i){
      drawStaff();
      if(i>8||i<0) drawLedgerLinesForIndex(i);
      const y=yForIndex(i);
      const cx=(left+right)/2;
      ctx.beginPath();
      ctx.ellipse(cx,y,lineGap*0.64,lineGap*0.48,-0.35,0,Math.PI*2);
      ctx.fillStyle='#000000';
      ctx.fill();
      const mid=4;
      ctx.beginPath();
      ctx.strokeStyle='#000000';
      if(i>mid){
        ctx.moveTo(cx+lineGap*0.55,y);
        ctx.lineTo(cx+lineGap*0.55,y-lineGap*2);
      } else {
        ctx.moveTo(cx-lineGap*0.55,y);
        ctx.lineTo(cx-lineGap*0.55,y+lineGap*2);
      }
      ctx.stroke();
    }

    function randomNote(){
      const i=randomIndex();
      return { index:i, y:yForIndex(i), name:nameForIndex(i) };
    }

    // ===== ××§×œ×“×ª =====
    const piano = document.getElementById('piano');
    const whiteKeysWrap = document.getElementById('whiteKeys');
    const blackKeysWrap = document.getElementById('blackKeys');

    const whiteOrder=['C','D','E','F','G','A','B'];
    function noteNameFromLetter(L){
      switch(L){
        case 'C':return '×“×•';
        case 'D':return '×¨×”';
        case 'E':return '××™';
        case 'F':return '×¤×”';
        case 'G':return '×¡×•×œ';
        case 'A':return '×œ×”';
        case 'B':return '×¡×™';
      }
    }

    function buildPiano(){
      whiteKeysWrap.innerHTML='';
      blackKeysWrap.innerHTML='';
      const whites=[];
      for(let o=4;o<=5;o++){
        for(const L of whiteOrder){ whites.push({letter:L, octave:o}); }
      }
      whites.forEach(w=>{
        const div=document.createElement('div');
        div.className='wkey';
        const name=noteNameFromLetter(w.letter);
        div.dataset.letter=w.letter;
        div.dataset.octave=w.octave;
        div.dataset.name=name;
        div.addEventListener('click',()=>{
          if(!timerControls.canAnswer) return;
          recordAndAdvance(name===currentNote.name);
        });
        whiteKeysWrap.appendChild(div);
      });

      requestAnimationFrame(()=>{
        placeBlackKeys(whites);
      });
    }

    function placeBlackKeys(whites){
      blackKeysWrap.innerHTML='';
      const pianoRect=piano.getBoundingClientRect();
      const whiteElems=[...whiteKeysWrap.children];
      if(whiteElems.length!==14) return;
      const centers=whiteElems.map(el=>{
        const r=el.getBoundingClientRect();
        return {left:r.left,right:r.right,center:(r.left+r.right)/2,width:r.width};
      });
      const whitesSeq=whites.map(w=>w.letter);
      const blackIdx=[];
      whitesSeq.forEach((L,i)=>{
        if(L==='C'||L==='D'||L==='F'||L==='G'||L==='A'){
          if(i+1<centers.length) blackIdx.push(i);
        }
      });
      const blackW=Math.max(14,Math.round(centers[0].width*0.6));
      blackIdx.forEach(i=>{
        const cx=(centers[i].right+centers[i+1].left)/2 - pianoRect.left;
        const b=document.createElement('div');
        b.className='bkey';
        b.style.left=cx+'px';
        b.style.width=blackW+'px';
        blackKeysWrap.appendChild(b);
      });
    }

    // ===== ××•×“×™×• =====
    let audioCtx=null;
    let soundEnabled=true;
    let convolver=null;

    function ensureAudio(){
      if(!audioCtx){
        try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
        catch(e){ console.warn('AudioContext failed',e); }
      }
      if(audioCtx && !convolver){
        const rev=audioCtx.createConvolver();
        rev.buffer=makeReverbImpulse(0.7,2.9);
        rev.connect(audioCtx.destination);
        convolver=rev;
      }
    }

    function makeReverbImpulse(seconds=0.6,decay=2.5){
      const rate=audioCtx.sampleRate;
      const len=Math.max(1,Math.floor(rate*seconds));
      const impulse=audioCtx.createBuffer(2,len,rate);
      for(let ch=0;ch<2;ch++){
        const data=impulse.getChannelData(ch);
        for(let i=0;i<len;i++){
          const t=i/len;
          const pink=(Math.random()*2-1)*(0.7+0.3*Math.random());
          data[i]=pink*Math.pow(1-t,decay);
        }
      }
      return impulse;
    }

    function noteIndexToSemitones(i){
      const steps=[1,2,2,2,1,2,2];
      if(i===0) return 0;
      let s=0; let idx=0;
      if(i>0){
        for(let k=1;k<=i;k++){ s+=steps[idx]; idx=(idx+1)%7; }
        return s;
      } else {
        idx=(7+((i%7)+7)%7-1)%7;
        for(let k=-1;k>=i;k--){ s-=steps[(idx+1)%7]; idx=(idx+6)%7; }
        return s;
      }
    }

    function freqForIndex(i){
      const base=329.628;
      const n=noteIndexToSemitones(i);
      return base*Math.pow(2,n/12);
    }

    function playPianoSynth(freq,dur=0.9){
      if(!soundEnabled) return;
      ensureAudio(); if(!audioCtx) return;
      const now=audioCtx.currentTime;
      const g=audioCtx.createGain();
      g.gain.setValueAtTime(0,now);
      g.gain.linearRampToValueAtTime(1.0,now+0.006);
      g.gain.exponentialRampToValueAtTime(0.55,now+0.18);
      g.gain.exponentialRampToValueAtTime(0.0001,now+dur);
      const pan=audioCtx.createStereoPanner();
      pan.pan.setValueAtTime((Math.random()*0.3-0.15),now);
      const presence=audioCtx.createBiquadFilter();
      presence.type='peaking';
      presence.frequency.value=2500;
      presence.Q.value=0.7;
      presence.gain.value=1.2;
      const hs=audioCtx.createBiquadFilter();
      hs.type='highshelf';
      hs.frequency.value=5200;
      hs.gain.value=-1.2;
      g.connect(presence).connect(hs).connect(pan).connect(audioCtx.destination);
      const wet=audioCtx.createGain();
      wet.gain.value=0.22;
      hs.connect(wet);
      if(convolver) wet.connect(convolver);

      const nbuf=audioCtx.createBuffer(1,Math.floor(audioCtx.sampleRate*0.018),audioCtx.sampleRate);
      const ndata=nbuf.getChannelData(0);
      for(let i=0;i<ndata.length;i++){
        ndata[i]=(Math.random()*2-1)*(1-i/ndata.length);
      }
      const nsrc=audioCtx.createBufferSource();
      nsrc.buffer=nbuf;
      const nhp=audioCtx.createBiquadFilter();
      nhp.type='highpass';
      nhp.frequency.value=1500;
      nhp.Q.value=0.9;
      nsrc.connect(nhp).connect(g);

      const B=Math.min(0.00035,0.00018+(freq-130)/4000*0.00012);
      const partialAmp=[1.00,0.58,0.34,0.22,0.15,0.11];
      for(let n=1;n<=partialAmp.length;n++){
        const o=audioCtx.createOscillator();
        o.type=(n<=2?'sine':(n<=4?'triangle':'sine'));
        const inharm=(n+B*Math.pow(n,3))/n;
        o.frequency.setValueAtTime(freq*n*inharm,now);
        const pg=audioCtx.createGain();
        const a=partialAmp[n-1];
        const tail=Math.max(0.18,0.9*(0.85/Math.pow(n,0.45)));
        pg.gain.setValueAtTime(0,now);
        pg.gain.linearRampToValueAtTime(a,now+0.006+n*0.002);
        pg.gain.exponentialRampToValueAtTime(0.0001,now+tail);
        o.connect(pg).connect(g);
        o.start(now);
        o.stop(now+tail+0.05);
      }

      const oF=audioCtx.createOscillator();
      oF.type='sine';
      oF.frequency.setValueAtTime(freq,now);
      const oB=audioCtx.createOscillator();
      oB.type='sine';
      oB.frequency.setValueAtTime(freq,now);
      oB.detune.setValueAtTime(-7,now);
      const gF=audioCtx.createGain();
      gF.gain.setValueAtTime(0.22,now);
      const gB=audioCtx.createGain();
      gB.gain.setValueAtTime(0.12,now);
      oF.connect(gF).connect(g);
      oB.connect(gB).connect(g);
      oF.start(now);
      oB.start(now);
      oF.stop(now+0.5);
      oB.stop(now+0.45);

      nsrc.start(now);
    }
    function playGrand(freq,dur=1.2){ playPianoSynth(freq,dur); }
    function playSquirrel(dur=0.2){
      if(!soundEnabled) return;
      ensureAudio(); if(!audioCtx) return;
      const now=audioCtx.currentTime;
      const bufferSize=audioCtx.sampleRate*dur;
      const buffer=audioCtx.createBuffer(1,bufferSize,audioCtx.sampleRate);
      const data=buffer.getChannelData(0);
      for(let i=0;i<bufferSize;i++){
        data[i]=(Math.random()*2-1)*Math.exp(-i/(bufferSize*0.6));
      }
      const src=audioCtx.createBufferSource();
      src.buffer=buffer;
      const bp=audioCtx.createBiquadFilter();
      bp.type='bandpass';
      bp.frequency.setValueAtTime(1800,now);
      bp.Q.value=4;
      const g=audioCtx.createGain();
      g.gain.setValueAtTime(0.9,now);
      g.gain.exponentialRampToValueAtTime(0.0001,now+dur);
      src.connect(bp).connect(g).connect(audioCtx.destination);
      src.start(now);
    }

    // ===== ××ª×’×¨ =====
    const TOTAL_QUESTIONS = 20;
    let activeGame = null;
    let history = loadHistory();
    let currentNote;
    let questionStartHR = 0;
    let currentStreak=0;

    const qCount = document.getElementById('questionCount');
    const correctCount = document.getElementById('correctCount');
    const wrongCount = document.getElementById('wrongCount');
    const percentSpan = document.getElementById('percent');
    const timerSpan = document.getElementById('timer');
    const timerChip = document.getElementById('timerChip');
    const progressBar = document.getElementById('progressBar');
    const feedback = document.getElementById('feedback');
    const toast = document.getElementById('toast');
    const confettiLayer = document.getElementById('confetti');

    let timerInterval=null;
    const timerControls={
      running:false,
      remaining:0,
      duration:CHALLENGE_CONFIG.fixedSeconds,
      infinite:!CHALLENGE_CONFIG.timed,
      canAnswer:false
    };

    function updateTimerUI(){
      if(!CHALLENGE_CONFIG.timed){
        timerChip.style.display='none';
      }else{
        timerChip.style.display='inline-flex';
        timerSpan.textContent = timerControls.remaining.toFixed(1)+'s';
      }
    }

    function pauseTimer(){
      if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
      timerControls.running=false;
      updateTimerUI();
    }

    function resetAndMaybeStartTimer(){
      if(!CHALLENGE_CONFIG.timed){
        timerControls.infinite=true;
        timerControls.canAnswer=true;
        timerControls.running=false;
        timerSpan.textContent='â€”';
        return;
      }
      timerControls.infinite=false;
      timerControls.duration=CHALLENGE_CONFIG.fixedSeconds;
      timerControls.remaining=timerControls.duration;
      timerControls.canAnswer=true;
      updateTimerUI();
      const start=performance.now();
      let lastRemaining=timerControls.remaining;
      timerControls.running=true;
      timerInterval=setInterval(()=>{
        const elapsed=(performance.now()-start)/1000;
        timerControls.remaining=Math.max(0,lastRemaining-elapsed);
        updateTimerUI();
        if(timerControls.remaining<=0){
          pauseTimer();
          recordAndAdvance(false);
        }
      },100);
    }

    function calcPercent(c,w){ const t=c+w; return t? Math.round((c/t)*100):0; }
    function formatDT(iso){ try{ return new Date(iso).toLocaleString('he-IL',{hour12:false}); }catch(e){ return iso; } }

    function confetti(N=60){
      confettiLayer.innerHTML='';
      const W=window.innerWidth;
      for(let i=0;i<N;i++){
        const p=document.createElement('i');
        p.style.left=Math.random()*W+'px';
        p.style.background=['#ffd54f','#4fc3f7','#81c784','#ff8a65'][i%4];
        p.style.animationDelay=(Math.random()*0.25)+'s';
        confettiLayer.appendChild(p);
      }
      setTimeout(()=>{ confettiLayer.innerHTML=''; },900);
    }
    function showToast(msg){
      toast.textContent=msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'),1600);
    }

    function pickAndDraw(){
      currentNote=randomNote();
      drawNoteByIndex(currentNote.index);
      if(activeGame){
        qCount.textContent=activeGame.currentQuestion;
        correctCount.textContent=activeGame.correct;
        wrongCount.textContent=activeGame.wrong;
        percentSpan.textContent=calcPercent(activeGame.correct,activeGame.wrong)+'%';
        progressBar.style.width=((activeGame.currentQuestion-1)/TOTAL_QUESTIONS*100)+'%';
      }
      feedback.textContent='';
      feedback.classList.remove('correct','wrong');
      resetAndMaybeStartTimer();
      questionStartHR=performance.now();
    }

    function recordAndAdvance(ok){
      pauseTimer();
      if(!activeGame) return;
      const elapsedSec=Math.max(0,(performance.now()-questionStartHR)/1000);

      if(navigator.vibrate){ navigator.vibrate(ok?30:[20,50,20]); }

      if(ok){
        currentStreak++;
        ensureAudio();
        playGrand(freqForIndex(currentNote.index));
        confetti(35);
        feedback.textContent='× ×›×•×Ÿ ×××•×“! ğŸ‰';
        feedback.classList.add('correct');
        feedback.classList.remove('wrong');
      } else {
        currentStreak=0;
        ensureAudio();
        playSquirrel(0.2);
        feedback.textContent=`×œ× × ×›×•×Ÿ. ×”×ª×©×•×‘×” ×”×™× ${currentNote.name}.`;
        feedback.classList.add('wrong');
        feedback.classList.remove('correct');
      }

      if(activeGame.currentQuestion < TOTAL_QUESTIONS){
        if(ok) activeGame.correct++; else activeGame.wrong++;
        activeGame.currentQuestion++;
        saveActiveGame(activeGame);
        correctCount.textContent=activeGame.correct;
        wrongCount.textContent=activeGame.wrong;
        percentSpan.textContent=calcPercent(activeGame.correct,activeGame.wrong)+'%';
        progressBar.style.width=((activeGame.currentQuestion-1)/TOTAL_QUESTIONS*100)+'%';
        setTimeout(()=>{ pickAndDraw(); },1300);
      } else {
        if(ok) activeGame.correct++; else activeGame.wrong++;
        const finishedAt=new Date().toISOString();
        const percent=calcPercent(activeGame.correct,activeGame.wrong);
        history=(history||[]);
        history.push({id:activeGame.id, finishedAt, correct:activeGame.correct, wrong:activeGame.wrong, percent, title:formatDT(finishedAt)});
        saveHistory(history);
        clearActiveGame();
        activeGame=null;
        showToast('××ª×’×¨ ×“××• ×”×•×©×œ×! ğŸµ');
      }
    }

    function startNewGame(){
      if(activeGame){
        alert('×›×‘×¨ ×™×© ××ª×’×¨ ×¤×¢×™×œ ×©×œ ×”×“××•. ×¡×™×™× ××•×ª×• ××• ××—×§ ××”Ö¾LocalStorage.');
        return;
      }
      activeGame={ id:'demo_'+Date.now(), startedAt:new Date().toISOString(), currentQuestion:1, correct:0, wrong:0 };
      saveActiveGame(activeGame);
      currentStreak=0;
      pickAndDraw();
    }

    function resumeActiveIfAny(){
      const stored=loadActiveGame();
      if(stored && stored.currentQuestion<=TOTAL_QUESTIONS){
        activeGame=stored;
      }
    }

    ['click','keydown','touchstart'].forEach(ev=>{
      document.addEventListener(ev,()=>{
        ensureAudio();
        if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
      },{once:true});
    });

    function init(){
      // ×ª××™×“ ××ª×—×™×œ×™× ×‘××¡×š ×”×¢×•×œ×
      switchScreen('world');
      resumeActiveIfAny();
    }

    window.addEventListener('resize',()=>{
      // ×¨×§ ×× ××¡×š ×”××ª×’×¨ ×’×œ×•×™ × ×‘×¦×¢ ××“×™×“×•×ª ×•×¨×™× ×“×•×¨ ××—×“×©
      if(challengeScreen.classList.contains('active')){
        sizeCanvas();
        buildPiano();
        if(activeGame) pickAndDraw();
      }
    });

    init();
  </script>
</body>
</html>
