<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
<title>×—×™×“×•×Ÿ ×ª×•×•×™× - ××©×—×§×•×Ÿ ×©×œ 50 + ×“×©×‘×•×¨×“</title>
<style>
  :root{ --card:#fff; --ink:#333; --accent:#004aad; --bg:#f0f8ff }
  *{ box-sizing:border-box }
  body {
    font-family: 'Comic Sans MS', 'Arial', sans-serif;
    background-color: var(--bg);
    direction: rtl;
    display: flex;
    gap: 12px;
    flex-direction: column; /* stack so no horizontal scroll */
    justify-content: flex-start;
    align-items: center;
    margin: 12px;
    color: var(--ink);
  }
  .quiz { text-align: center; flex: 1; width: 100%; max-width: 620px; }
  .btn-row{ display:flex; justify-content:center; gap:12px; flex-wrap:wrap }
  .controls-row{ display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:nowrap; margin-top:6px }
  .icon-btn{ border:1px solid var(--ink); background:#fff; border-radius:10px; padding:8px 10px; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; line-height:1 }
  .icon-btn svg{ width:22px; height:22px }
  #difficultySelect{ font-size:18px; padding:6px 10px }
  label[for="difficultySelect"]{ font-size:18px }
  .stats {
    width: 100%; max-width: 620px; background: var(--card); border: 2px solid var(--ink); border-radius: 12px;
    padding: 10px; font-size: 15px; position: static; margin-top: 6px;
  }
  canvas { border: 2px solid var(--ink); background-color: white; margin: 8px auto; display: block; width: 100%; max-width: 340px; height: auto; }
  input[type=text]{ padding: 12px; font-size: 18px; margin-top: 6px; width: min(90%, 360px); }
  button{ padding: 12px 18px; font-size: 16px; margin: 8px; cursor: pointer; border-radius: 10px; border: 1px solid var(--ink); background:#fff }
  #feedback{ font-weight: bold; margin-top: 8px; min-height: 24px; }
  .correct{ color: green; } .wrong{ color: red; } .hidden{ display:none }

  /* Dashboard */
  .dashboard{ max-width: 980px; margin: 0 auto; background: var(--card); border: 3px solid var(--accent); border-radius: 16px; padding: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.2) }
  .dashboard h1{ font-size: 2rem; color: var(--accent); text-shadow: 2px 2px 3px #aad4ff; text-align: center; margin-bottom: 6px }
  .dashboard h2{ text-align:center; color: var(--ink) }
  table{ width:100%; border-collapse: collapse; margin-top: 10px }
  th, td{ border:1px solid #ddd; padding:8px; text-align:center }
  th{ background:#f0f0f0 }
  .muted{ color:#666; font-size:14px; text-align:center }

  /* ===== Mobile layout ===== */
  @media (max-width: 768px){
    body{ margin: 8px }
    h2{ font-size: 1.1rem; margin-bottom:6px }
    .stats{ width:100%; font-size:14px }
    button{ width:auto }
    input[type=text]{ width:100%; font-size:17px }
    .dashboard{ padding:10px }
    .dashboard h1{ font-size:1.4rem }
    /* Compact mobile control bar so no vertical scroll */
    .controls-row{ gap:8px; margin-top:6px }
    .icon-btn svg{ width:24px; height:24px }
    #difficultySelect{ font-size:20px }
    label[for="difficultySelect"]{ font-size:20px }
  }
</style>
</head>
<body>
  <!-- QUIZ AREA -->
  <div id="quizArea" class="quiz">
    <h2>ğŸµ ×—×™×“×•×Ÿ ×–×™×”×•×™ ×ª×•×•×™× ×‘××¤×ª×— ×¡×•×œ ğŸµ</h2>
    <div class="btn-row">
      <!-- Fullscreen shown only on mobile via JS -->
      <button id="fullscreenBtn" class="hidden">××¡×š ××œ×</button>
    </div>
    <canvas id="staffCanvas" aria-label="×—××©×” ×‘××¤×ª×— ×¡×•×œ"></canvas>
    <p class="muted" style="margin:4px 0 2px">××” ×©× ×”×ª×• ×©××•×¤×™×¢?</p>
    <form id="answerForm" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" style="display:inline-block; width:100%; max-width:560px;">
      <input type="text" id="answerInput" placeholder="×”×§×œ×“ ×›××Ÿ ××ª ×©× ×”×ª×•..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="latin" />
    </form>
    <div class="btn-row">
      <button id="checkBtn">×‘×“×•×§ ×ª×©×•×‘×”</button>
      <button id="nextBtn">×”×‘×</button>
    </div>
    <div class="controls-row">
      <label for="difficultySelect" class="muted">×¨××ª ×§×•×©×™:</label>
      <select id="difficultySelect">
        <option value="staff">×‘×ª×•×š ×”×—××©×”</option>
        <option value="plus2">×—××©×” + 2 ×§×•×•×™ ×¢×–×¨</option>
        <option value="plus4">×—××©×” + 4 ×§×•×•×™ ×¢×–×¨</option>
      </select>
      <!-- Icons row: dashboard & zoom (mobile-friendly) -->
      <button id="toDashboardIcon" class="icon-btn" title="×œ×“×©×‘×•×¨×“ ×”××©×—×§×•× ×™×" aria-label="×œ×“×©×‘×•×¨×“ ×”××©×—×§×•× ×™×">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="7" height="7"></rect>
          <rect x="14" y="3" width="7" height="7"></rect>
          <rect x="14" y="14" width="7" height="7"></rect>
          <rect x="3" y="14" width="7" height="7"></rect>
        </svg>
      </button>
      <button id="zoomIcon" class="icon-btn" title="×–×•×" aria-label="×–×•×">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="7"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          <line x1="11" y1="8" x2="11" y2="14"></line>
          <line x1="8" y1="11" x2="14" y2="11"></line>
        </svg>
      </button>
    </div>
    <div id="feedback"></div>
  </div>

  <!-- STATS PANEL -->
  <div class="stats" id="statsPanel">
    <h3>×¡×˜×˜×™×¡×˜×™×§×” â€” ××©×—×§×•×Ÿ × ×•×›×—×™</h3>
    <p class="muted">×™×© ×¨×§ ××©×—×§×•×Ÿ ×¤×¢×™×œ ××—×“ ×‘×›×œ ×¨×’×¢.</p>
    <p>×©××œ×” <span id="questionCount">1</span> ××ª×•×š 50</p>
    <p class="correct">× ×›×•× ×•×ª: <span id="correctCount">0</span></p>
    <p class="wrong">×˜×¢×•×™×•×ª: <span id="wrongCount">0</span></p>
    <p>××—×•×– ×”×¦×œ×—×”: <strong id="percent">0%</strong></p>
  </div>

  <!-- DASHBOARD (all gamelets) -->
  <div id="dashboardArea" class="dashboard hidden" aria-live="polite">
    <h1>ğŸ¶ ×—×™×“×•×Ÿ ×–×™×”×•×™ ×ª×•×•×™× ×‘××¤×ª×— ×¡×•×œ ğŸ¶</h1>
    <h2>×“×©×‘×•×¨×“ ×”××©×—×§×•× ×™×</h2>
    <p class="muted">×›×œ ×©×•×¨×” ××™×™×¦×’×ª ××©×—×§×•×Ÿ ×©×œ 50 ×©××œ×•×ª ×©×”×•×©×œ×. ×”×›×•×ª×¨×ª ×”×™× ×”Ö¾Date & Time ×©×œ ×¡×™×•× ×”××©×—×§×•×Ÿ.</p>
    <table>
      <thead>
        <tr>
          <th>×©× (×ª××¨×™×š ×•×©×¢×”)</th>
          <th class="correct">× ×›×•× ×•×ª</th>
          <th class="wrong">×˜×¢×•×™×•×ª</th>
          <th>××—×•×– ×”×¦×œ×—×”</th>
        </tr>
      </thead>
      <tbody id="dashboardTableBody"></tbody>
    </table>
    <div style="text-align:right; font-size:12px; color:#777; margin-top:10px;">×’×¨×¡×” 0.3</div>
    <div style="text-align:center; margin-top: 12px;" class="btn-row">
      <button id="backToActiveBtn">×—×–×¨×” ×œ××©×—×§×•×Ÿ ×”×¤×¢×™×œ</button>
      <button id="startNewBtn">×”×ª×—×œ ××©×—×§×•×Ÿ ×—×“×©</button>
    </div>
  </div>

<script>
// ===== Environment detection & helpers =====
const isMobile = /(Mobi|Android|iPhone|iPad|iPod|webOS)/i.test(navigator.userAgent) || window.matchMedia('(max-width: 768px)').matches;
document.documentElement.classList.toggle('mobile', isMobile);
// Show fullscreen button only on mobile
const fsBtnInitial = document.getElementById('fullscreenBtn');
if (fsBtnInitial) fsBtnInitial.classList.toggle('hidden', !isMobile);

// ===== Persistence helpers (localStorage) =====
const STORAGE_KEYS = { ACTIVE: 'noteQuiz_activeGame', HISTORY: 'noteQuiz_history', DIFFICULTY: 'noteQuiz_difficulty' };
const saveActiveGame = s => localStorage.setItem(STORAGE_KEYS.ACTIVE, JSON.stringify(s));
const loadActiveGame = () => { const r = localStorage.getItem(STORAGE_KEYS.ACTIVE); return r ? JSON.parse(r) : null };
const clearActiveGame = () => localStorage.removeItem(STORAGE_KEYS.ACTIVE);
const saveHistory = a => localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(a));
const loadHistory = () => { const r = localStorage.getItem(STORAGE_KEYS.HISTORY); return r ? JSON.parse(r) : [] };

// ===== Canvas Reflow & Geometry =====
const canvas = document.getElementById('staffCanvas');
const ctx = canvas.getContext('2d');
let DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
let CW = 560; // logical CSS width
let CH = isMobile ? 240 : 300; // logical CSS height
let left, right, topLineY, bottomLineY, lineGap;

function sizeCanvas() {
  canvas.style.width = '100%';
  const rect = canvas.getBoundingClientRect();
  const widthCandidate = rect && rect.width ? rect.width : 340;
  const cssWidth = Math.min(340, widthCandidate);
  const cssHeight = Math.round(cssWidth * 0.5);
  DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));
  canvas.width = Math.floor(cssWidth * DPR);
  canvas.height = Math.floor(cssHeight * DPR);
  canvas.style.height = cssHeight + 'px';
  ctx.setTransform(DPR, 0, 0, DPR, 0, 0);

  CW = cssWidth; CH = cssHeight;
  lineGap = Math.min(Math.max(CH * 0.10, 14), 26); // distance between staff lines
  const staffMidY = Math.round(CH * 0.5);
  topLineY = Math.round(staffMidY - 2 * lineGap);     // F5 (line 5)
  bottomLineY = Math.round(topLineY + 4 * lineGap);   // E4 (line 1)
  left = Math.round(CW * 0.12); right = Math.round(CW * 0.88);
}

// ===== Pitch geometry (index-based) =====
// Define an index i where i=0 => E4 (bottom line). Each step of +1 is next diatonic note (space/line),
// so vertical delta per step is lineGap/2.
function yForIndex(i){ return bottomLineY - i * (lineGap/2); }
function nameForIndex(i){
  // Sequence starting at E (××™): [E,F,G,A,B,C,D]
  const names = ['××™','×¤×”','×¡×•×œ','×œ×”','×¡×™','×“×•','×¨×”'];
  const m = ((i % 7) + 7) % 7; // proper positive modulo
  return names[m];
}

// Difficulty ranges in index space
function indexRangeByDifficulty(){
  // Staff-only: E4..F5 => 0..8
  // +2 ledger: A3..C6 => -4..12
  // +4 ledger: D3..G6 => -8..16
  if (difficulty===DIFFICULTY.STAFF_ONLY) return {min:0, max:8};
  if (difficulty===DIFFICULTY.PLUS_2) return {min:-4, max:12};
  return {min:-8, max:16};
}
function randomIndex(){
  const {min, max} = indexRangeByDifficulty();
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// ===== Difficulty =====
const DIFFICULTY = { STAFF_ONLY:'staff', PLUS_2:'plus2', PLUS_4:'plus4' };
let difficulty = localStorage.getItem('noteQuiz_difficulty') || DIFFICULTY.PLUS_2;
function setDifficulty(newLevel){ difficulty=newLevel; localStorage.setItem('noteQuiz_difficulty', difficulty); pickAndDraw(); }

// ===== Game State =====
let activeGame = null; // {id, startedAt, currentQuestion, correct, wrong}
let history = loadHistory();
let currentNote; const TOTAL_QUESTIONS = 50;

// ===== UI Refs =====
const feedback = document.getElementById('feedback');
const answerInput = document.getElementById('answerInput');
const answerForm = document.getElementById('answerForm');
if (answerForm) answerForm.addEventListener('submit', (e)=> e.preventDefault());
if (answerInput){
  answerInput.setAttribute('name', 'ans_'+Date.now());
  answerInput.setAttribute('autocomplete','off');
  answerInput.setAttribute('autocorrect','off');
  answerInput.setAttribute('autocapitalize','off');
  answerInput.setAttribute('spellcheck','false');
}
const qCount = document.getElementById('questionCount');
const correctCount = document.getElementById('correctCount');
const wrongCount = document.getElementById('wrongCount');
const percentSpan = document.getElementById('percent');
const quizArea = document.getElementById('quizArea');
const statsPanel = document.getElementById('statsPanel');
const dashboardArea = document.getElementById('dashboardArea');
const dashboardTableBody = document.getElementById('dashboardTableBody');

// ===== Utilities =====
const formatDT = (iso)=>{ try{ return new Date(iso).toLocaleString('he-IL',{hour12:false}); }catch(e){ return iso } };
const calcPercent = (c,w)=>{ const t=c+w; return t? Math.round((c/t)*100):0 };

// ===== Drawing =====
function drawStaff(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.lineWidth = 1.5;
  for (let i=0;i<5;i++){
    const y = topLineY + i*lineGap;
    ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke();
  }
  ctx.font = Math.round(lineGap*2) + 'px serif';
  ctx.fillText('ğ„', left - lineGap*0.8, topLineY + lineGap*2.7);
}

function drawLedgerLinesForIndex(i){
  const cx=(left+right)/2, half=Math.max(18, lineGap*1.1);
  // Above staff: first ledger line index is 10 (A5), then 12,14,16...
  if (i >= 10){
    for (let li=10; li<=i; li+=2){
      const y = yForIndex(li);
      ctx.beginPath(); ctx.moveTo(cx-half,y); ctx.lineTo(cx+half,y); ctx.stroke();
    }
  }
  // Below staff: first ledger line index is -2 (C4), then -4,-6,-8...
  if (i <= -2){
    for (let li=-2; li>=i; li-=2){
      const y = yForIndex(li);
      ctx.beginPath(); ctx.moveTo(cx-half,ly=y); ctx.lineTo(cx+half,ly); ctx.stroke();
    }
  }
}

function drawNoteByIndex(i){
  drawStaff();
  if (i>8 || i<0) drawLedgerLinesForIndex(i);
  const y = yForIndex(i);
  const cx=(left+right)/2;
  ctx.beginPath(); ctx.ellipse(cx, y, lineGap*0.6, lineGap*0.45, -0.35, 0, Math.PI*2); ctx.fillStyle='#000'; ctx.fill();
  const midIndex = 4; // B4 line
  if (i > midIndex){ ctx.beginPath(); ctx.moveTo(cx+lineGap*0.5, y); ctx.lineTo(cx+lineGap*0.5, y - lineGap*1.8); ctx.stroke(); }
  else { ctx.beginPath(); ctx.moveTo(cx-lineGap*0.5, y); ctx.lineTo(cx-lineGap*0.5, y + lineGap*1.8); ctx.stroke(); }
}

function randomNote(){
  const i = randomIndex();
  return { index: i, y: yForIndex(i), name: nameForIndex(i) };
}
function pickAndDraw(){
  currentNote = randomNote();
  drawNoteByIndex(currentNote.index);
  if(activeGame){ qCount.textContent=activeGame.currentQuestion; correctCount.textContent=activeGame.correct; wrongCount.textContent=activeGame.wrong; percentSpan.textContent=calcPercent(activeGame.correct, activeGame.wrong)+'%'; }
  feedback.textContent=''; answerInput.value=''; answerInput.focus();
}

// ===== Answer Handling =====
function normalizeAnswer(str){
  const s=(str||'').trim().toLowerCase();
  const map={ '×“×•':'×“×•','do':'×“×•','×¨×”':'×¨×”','re':'×¨×”','××™':'××™','mi':'××™','×¤×”':'×¤×”','fa':'×¤×”','×¡×•×œ':'×¡×•×œ','sol':'×¡×•×œ','×œ×”':'×œ×”','la':'×œ×”','×¡×™':'×¡×™','si':'×¡×™','ti':'×¡×™' };
  return map[s]||s;
}
function recordAndAdvance(ok){
  if(!activeGame) return;
  // Haptics
  if (navigator.vibrate) { navigator.vibrate(ok ? 30 : [20,50,20]); }
  // Visual feedback (1.5s)
  if(ok){
    activeGame.correct++;
    feedback.textContent='× ×›×•×Ÿ ×××•×“! ğŸ‰';
    feedback.style.color='green';
    feedback.classList.add('correct');
    feedback.classList.remove('wrong');
  } else {
    activeGame.wrong++;
    feedback.textContent=`×œ× × ×›×•×Ÿ. ×”×ª×©×•×‘×” ×”×™× ${currentNote.name}.`;
    feedback.style.color='red';
    feedback.classList.add('wrong');
    feedback.classList.remove('correct');
  }
  if(activeGame.currentQuestion < 50){
    activeGame.currentQuestion++;
    saveActiveGame(activeGame);
    correctCount.textContent=activeGame.correct;
    wrongCount.textContent=activeGame.wrong;
    percentSpan.textContent=calcPercent(activeGame.correct, activeGame.wrong)+'%';
    setTimeout(pickAndDraw, 1500);
  } else {
    const finishedAt=new Date().toISOString();
    const percent=calcPercent(activeGame.correct, activeGame.wrong);
    const title=formatDT(finishedAt);
    const historyArr=history||[];
    historyArr.push({id:activeGame.id, finishedAt, correct:activeGame.correct, wrong:activeGame.wrong, percent, title});
    history=historyArr;
    saveHistory(history);
    clearActiveGame();
    activeGame=null;
    renderDashboard();
    showDashboard();
  }
}
function checkCurrentAnswer(){ const ans=normalizeAnswer(answerInput.value); if(!ans){ feedback.textContent='×× × ×›×ª×•×‘ ×ª×©×•×‘×”.'; feedback.style.color='black'; return null } return ans===currentNote.name }

// ===== Dashboard =====
function renderDashboard(){ dashboardTableBody.innerHTML=''; if(!history.length){ const tr=document.createElement('tr'); tr.innerHTML = `<td colspan="4" class="muted">××™×Ÿ ×¢×“×™×™×Ÿ ××©×—×§×•× ×™× ×©×”×•×©×œ××•</td>`; dashboardTableBody.appendChild(tr); return } const rows=[...history].sort((a,b)=> new Date(b.finishedAt)-new Date(a.finishedAt)); rows.forEach(g=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${g.title}</td><td class="correct">${g.correct}</td><td class="wrong">${g.wrong}</td><td>${g.percent}%</td>`; dashboardTableBody.appendChild(tr) }) }
function showDashboard(){ quizArea.classList.add('hidden'); statsPanel.classList.add('hidden'); dashboardArea.classList.remove('hidden') }
function showQuiz(){ dashboardArea.classList.add('hidden'); quizArea.classList.remove('hidden'); statsPanel.classList.remove('hidden'); pickAndDraw() }

// ===== Start / Resume game =====
function startNewGame(){ if(activeGame){ alert('×›×‘×¨ ×™×© ××©×—×§×•×Ÿ ×¤×¢×™×œ. ×¡×™×™× ××•×ª×• ××• ×¢×‘×•×¨ ×œ×“×©×‘×•×¨×“.'); return } activeGame={ id:'game_'+Date.now(), startedAt:new Date().toISOString(), currentQuestion:1, correct:0, wrong:0 }; saveActiveGame(activeGame); showQuiz() }
function resumeActiveIfAny(){ const stored=loadActiveGame(); if(stored && (stored.currentQuestion<=50)){ activeGame=stored; showQuiz() } else { startNewGame() } }

// ===== Listeners =====
document.getElementById('checkBtn').addEventListener('click', ()=>{ const r=checkCurrentAnswer(); if(r===null) return; recordAndAdvance(r) });
document.getElementById('nextBtn').addEventListener('click', ()=>{ const r=checkCurrentAnswer(); if(r===null) return; recordAndAdvance(r) });
answerInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const r=checkCurrentAnswer(); if(r===null) return; recordAndAdvance(r) } });

// Dashboard icon
const toDashboardIcon = document.getElementById('toDashboardIcon');
if (toDashboardIcon) {
  toDashboardIcon.addEventListener('click', () => {
    renderDashboard();
    showDashboard();
  });
}
const backToActiveBtn=document.getElementById('backToActiveBtn'); if(backToActiveBtn) backToActiveBtn.addEventListener('click', ()=>{ const stored=loadActiveGame(); if(stored){ activeGame=stored; showQuiz() } else { startNewGame() } });
const startNewBtn=document.getElementById('startNewBtn'); if(startNewBtn) startNewBtn.addEventListener('click', startNewGame);

const difficultySelect=document.getElementById('difficultySelect'); if(difficultySelect){ difficultySelect.value=difficulty; difficultySelect.addEventListener('change', e=> setDifficulty(e.target.value)) }

// Fullscreen support (mobile-first with fallback)
const fsBtn = document.getElementById('fullscreenBtn');
function enterPseudoFullscreen(){ document.body.style.position='fixed'; document.body.style.inset='0'; document.body.style.overflow='hidden'; window.scrollTo(0,0); sizeCanvas(); }
function exitPseudoFullscreen(){ document.body.style.position=''; document.body.style.inset=''; document.body.style.overflow=''; sizeCanvas(); }
async function toggleFullscreen(){
  try{
    if(!document.fullscreenElement){
      if(document.documentElement.requestFullscreen){ await document.documentElement.requestFullscreen(); }
      else { enterPseudoFullscreen(); }
    } else {
      if(document.exitFullscreen){ await document.exitFullscreen(); }
      else { exitPseudoFullscreen(); }
    }
  }catch(e){ if(document.body.style.position==='fixed') exitPseudoFullscreen(); else enterPseudoFullscreen(); }
}
if (fsBtn) fsBtn.addEventListener('click', toggleFullscreen);
document.addEventListener('fullscreenchange', ()=>{ sizeCanvas(); });

// Zoom toggle
const zoomBtn = document.getElementById('zoomIcon');
let zoomed = false;
function toggleZoom(){ zoomed = !zoomed; const scale = zoomed ? 1.5 : 1; canvas.style.transform = `scale(${scale})`; canvas.style.transformOrigin = 'center'; }
if (zoomBtn) zoomBtn.addEventListener('click', toggleZoom);
canvas.addEventListener('dblclick', toggleZoom);

// ===== Simple runtime tests (console) =====
(function selfTests(){
  try {
    console.group('%cSelf tests','color: #004aad');
    sizeCanvas();
    // Geometry tests: mapping indices to Y
    console.assert(yForIndex(0) === bottomLineY, 'E4 index 0 should be bottom line');
    console.assert(Math.abs(yForIndex(8) - topLineY) <= 0.5, 'F5 index 8 should be top line');
    // Name mapping tests
    console.assert(nameForIndex(0)==='××™' && nameForIndex(1)==='×¤×”' && nameForIndex(2)==='×¡×•×œ', 'Name cycle E-F-G OK');
    console.assert(nameForIndex(5)==='×“×•' && nameForIndex(6)==='×¨×”', 'Name cycle C-D OK');
    // Difficulty pools monotonic
    const range = indexRangeByDifficulty();
    console.assert(range.min <= range.max, 'Range sanity');
    // UI expectations
    console.assert(document.getElementById('fullscreenBtn').classList.contains('hidden') === !isMobile, 'Fullscreen visible only on mobile');
    console.assert(!!document.getElementById('toDashboardIcon'), 'Dashboard icon present');
    console.assert(!!document.getElementById('zoomIcon'), 'Zoom icon present');
    // Answer normalization tests (extra)
    console.assert(normalizeAnswer('mi')==='××™' && normalizeAnswer('fa')==='×¤×”', 'Latin alias mapping');
    console.assert(normalizeAnswer(' ×“×• ')==='×“×•', 'Whitespace trimmed');
    console.log('âœ… Self tests passed');
    console.groupEnd();
  } catch(err){ console.error('Self tests failed:', err); }
})();

// ===== Init =====
function init(){ sizeCanvas(); renderDashboard(); resumeActiveIfAny(); }
window.addEventListener('resize', ()=>{ const wasDash = !dashboardArea.classList.contains('hidden'); sizeCanvas(); if(!wasDash) pickAndDraw() });
init();
</script>
</body>
</html>
